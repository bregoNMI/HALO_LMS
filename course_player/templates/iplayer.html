<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    {% load static %}
    
    <p>If you can see this text, the HTML is rendering correctly.</p>
    <p>Signed URL: {{ scorm_index_file_url }}</p>

    <!-- Include the SCORM API JavaScript wrapper -->
    <script src="{% static 'course_player/javascript/SCORM_API_wrapper.js' %}?v=2"></script>

    <script>
        console.log("iplayer.html script loaded");

        // Define the global lesson ID and user ID
        window.lessonId = "{{ lesson.id }}";
        window.userId = "{{ profile_id }}";
        window.savedLocation = "{{ saved_location|escapejs }}"; // Passed from Django
        window.savedProgress = parseFloat("{{ saved_progress }}") || 0;
        window.savedScrollPosition = parseInt("{{ saved_scroll_position|escapejs }}", 10) || 0;

        let totalPages = 0;
        let pagesVisited = new Set();

        console.log("Profile ID:", window.userId);

        // Initialize session start time globally
        let sessionStartTime = new Date();

        // Ensure SCORM API is available globally
        window.API_1484_11 = window.API_1484_11 || {
            Initialize: () => {
                console.log("SCORM API: Initialize called");
                sessionStartTime = new Date(); // Set the session start time
                return "true";
            },
            Terminate: () => {
                console.log("SCORM API: Terminate called");
                return "true";
            },
            GetValue: (key) => {
                console.log(`SCORM API: GetValue called for key: ${key}`);
                
                // Retrieve from mock data store
                return this.dataStore ? this.dataStore[key] || "" : "";
            },
            SetValue: (key, value) => {
                console.log(`SCORM API: SetValue called for key: ${key}, value: ${value}`);
                
                // Persist progress measure in a mock data store
                if (!this.dataStore) {
                    this.dataStore = {}; // Create a mock data store if it doesn't exist
                }
                this.dataStore[key] = value; // Store the key-value pair

                return "true";
            },
            Commit: () => {
                console.log("SCORM API: Commit called");
                return "true";
            },
            SetBookmark: () => {
                console.log("SCORM API: SetBookmark called");
                return "true";
            },
            CommitData: () => {
                console.log("SCORM API: CommitData called");
                return "true";
            },
            GetLastError: () => "0",
            GetErrorString: (errorCode) => "No error",
            GetDiagnostic: (errorCode) => "",
        };

        // Function to calculate session time
        function getSessionTime() {
            const now = new Date();
            const duration = Math.floor((now - sessionStartTime) / 1000); // Duration in seconds

            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;

            return `PT${hours}H${minutes}M${seconds}S`;
        }

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getTotalPagesFromIframe() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe && iframe.contentWindow) {
                try {
                    const iframeDocument = iframe.contentWindow.document;

                    // Adjust selectors to match the structure of your SCORM content
                    const slides = iframeDocument.querySelectorAll(".slide, .page"); // Example selectors
                    console.log("Slides Found:", slides.length);

                    return slides.length;
                } catch (error) {
                    console.error("Unable to access iframe content:", error);
                }
            }
            return 0; // Default fallback if pages are not found
        }

        function updateTotalPages() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe) {
                iframe.addEventListener("load", () => {
                    totalPages = getTotalPagesFromIframe();
                    console.log("Total Pages Updated:", totalPages); // Display total pages in the console
                });
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateTotalPages(); // Initialize the process to count total pages
        });

        function trackProgress() {
            try {
                console.log("Attempting to track progress...");
                const iframe = document.getElementById("scormContentIframe");
                
                if (!iframe || !iframe.contentWindow) {
                    console.error("SCORM iframe not found.");
                    return;
                }

                const progressMeasure = getProgressFromIframe();
                const lessonLocation = iframe.contentWindow.location.href;
                const scrollPosition = iframe.contentWindow.scrollY || 0; // âœ… Capture scroll position

                console.log(`Captured Scroll Position: ${scrollPosition}`); // Debugging output

                if (progressMeasure > 0) {
                    window.API_1484_11.SetValue("cmi.progress_measure", progressMeasure.toFixed(2));
                    window.API_1484_11.SetValue("cmi.location", lessonLocation);
                    window.API_1484_11.SetValue("cmi.scroll_position", scrollPosition);

                    console.log(`Progress: ${progressMeasure}, Location: ${lessonLocation}, Scroll: ${scrollPosition}`);

                    sendTrackingData({
                        lesson_id: window.lessonId,
                        user_id: window.userId,
                        progress: progressMeasure,
                        lesson_location: lessonLocation,
                        scroll_position: scrollPosition,  // âœ… Send scroll position to backend
                        completion_status: progressMeasure === 1 ? "complete" : "incomplete",
                        session_time: getSessionTime(),
                        score: null,
                    });
                } else {
                    console.warn("Progress measure not found or is 0.");
                }
            } catch (error) {
                console.error("Error tracking progress:", error);
            }
        }

        function sendTrackingData(trackingData) {
            console.log("ðŸ“¡ Sending SCORM tracking data to server...");

            fetch('/course_player/track-scorm-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(trackingData),
            })
            .then(response => response.json())
            .then(data => console.log("âœ… SCORM progress updated:", data))
            .catch(error => console.error("ðŸš¨ Error tracking SCORM data:", error));
        }

        function sendMiniLessonProgress(lessonProgressArray) {
            console.log("ðŸ“¡ Sending mini-lesson progress to server...", lessonProgressArray);

            fetch('/course_player/track-mini-lesson-progress/', {  // New API endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    user_id: window.userId,
                    lesson_progress: lessonProgressArray
                }),
            })
            .then(response => response.json())
            .then(data => console.log("âœ… Mini-lesson progress updated:", data))
            .catch(error => console.error("ðŸš¨ Error tracking mini-lesson progress:", error));
        }

        function trackMiniLessonProgress() {
            console.log("ðŸ” Checking mini-lesson progress...");

            let lessonProgressArray = [];
            const iframe = document.getElementById("scormContentIframe");

            if (iframe && iframe.contentWindow) {
                const progressElements = iframe.contentWindow.document.querySelectorAll('[aria-label*="Completed"], [aria-label*="% Completed"]');

                progressElements.forEach((el, index) => {
                    const progressText = el.getAttribute("aria-label") || "Unknown";
                    const miniLessonId = el.getAttribute("data-lesson-id") || window.lessonId; 
                    const miniLessonIndex = index;

                    lessonProgressArray.push({
                        lesson_id: miniLessonId,  // âœ… Sending unique mini-lesson ID
                        user_id: window.userId,
                        progress: progressText
                    });
                });

                console.log("ðŸ“Š Extracted Lesson Progress Data:", lessonProgressArray);

                if (lessonProgressArray.length > 0) {
                    console.log("ðŸ” BEFOOOOOOOOOOOOOOOOOOOOOOREEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE..");
                    sendMiniLessonProgress(lessonProgressArray);  // âœ… Send to backend
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("Adding progress tracking interval.");
            setInterval(trackProgress, 30000);  // Track progress and scroll position every 30 seconds
            setInterval(trackMiniLessonProgress, 30000);
        });

        //function updateProgress(currentPage) {
            // Add current page to visited set
            //pagesVisited.add(currentPage);

            //if (totalPages > 0) {
                //const progress = pagesVisited.size / totalPages;
                //window.API_1484_11.SetValue("cmi.progress_measure", progress.toFixed(2));
                //console.log(`Progress Updated: ${progress}`);
                //trackProgress();
            //}
        //}

        function getProgressFromIframe() {
            const iframe = document.getElementById("scormContentIframe");
            console.log("Checking iframe for progress...");

            if (iframe && iframe.contentWindow) {
                try {
                    const iframeDocument = iframe.contentWindow.document;

                    // Select the element containing the progress text
                    const progressElement = iframeDocument.querySelector(".nav-sidebar-header__progress-text");
                    if (progressElement) {
                        const progressText = progressElement.textContent.trim();
                        console.log("Progress Element Text Found:", progressText);

                        // Extract numeric value from progress text (e.g., "10% COMPLETE")
                        const progressMatch = progressText.match(/(\d+)%/);
                        if (progressMatch) {
                            const progressValue = parseInt(progressMatch[1], 10);
                            console.log("Extracted Progress Value:", progressValue);

                            return progressValue / 100; // Convert to decimal (e.g., 0.1)
                        }
                    } else {
                        console.warn("No progress element found matching the selector.");
                    }
                } catch (error) {
                    console.error("Error accessing iframe content for progress:", error);
                }
            } else {
                console.error("Iframe or iframe.contentWindow not available.");
            }
            return 0; // Default progress if not found
        }

        function updateSidebarProgress() {
            console.log("Updating sidebar progress on page load...");

            let attemptCount = 0;
            function tryUpdateProgress() {
                let savedProgress = window.savedProgress;
                const progressPercentage = Math.round(savedProgress * 100); // Convert decimal to percentage

                // Get the progress bar elements inside the iframe
                const iframe = document.getElementById("scormContentIframe");
                if (iframe && iframe.contentWindow) {
                    try {
                        const iframeDocument = iframe.contentWindow.document;
                        
                        // Select the progress text and progress bar elements
                        const progressTextElement = iframeDocument.querySelector(".nav-sidebar-header__progress-text");
                        const progressBarElement = iframeDocument.querySelector(".nav-sidebar-header__progress-runner"); // Adjusted selector
                        
                        if (progressTextElement) {
                            progressTextElement.textContent = `${progressPercentage}% COMPLETE`;
                            console.log(`âœ… Updated sidebar progress text to ${progressPercentage}%`);
                        }

                        if (progressBarElement) {
                            progressBarElement.style.width = `${progressPercentage}%`;
                            progressBarElement.style.transition = "width 0.5s ease-in-out"; // Smooth transition effect
                            console.log(`âœ… Updated sidebar progress bar width to ${progressPercentage}%`);
                        } else if (attemptCount < 10) {
                            attemptCount++;
                            console.warn(`âš ï¸ Progress bar not found, retrying... (${attemptCount})`);
                            setTimeout(tryUpdateProgress, 500); // Retry after 500ms
                        } else {
                            console.error("ðŸš¨ Failed to update progress bar after multiple attempts.");
                        }
                    } catch (error) {
                        console.error("âš ï¸ Error accessing iframe content for progress update:", error);
                    }
                } else {
                    console.warn("âš ï¸ Iframe not fully loaded, retrying...");
                    setTimeout(tryUpdateProgress, 500);
                }
            }

            // Start the retry mechanism
            setTimeout(tryUpdateProgress, 500);
        }

        // Run this function when the SCORM iframe loads
        document.addEventListener("DOMContentLoaded", function () {
            const iframe = document.getElementById("scormContentIframe");

            iframe.addEventListener("load", function () {
                console.log("âœ… SCORM content loaded, updating progress bar...");
                updateSidebarProgress();
            });
        });

        // Ensure progress tracking starts only after iframe loads
        document.addEventListener("DOMContentLoaded", function () {
            let iframe = document.getElementById("scormContentIframe");

            iframe.addEventListener("load", function () {
                console.log("âœ… SCORM content iframe loaded, starting progress tracking...");
                setTimeout(() => trackMiniLessonProgress(), 3000); // Wait 3 seconds before first attempt
            });
        });

        function getMiniLessonProgress(scoIndex) {
            if (window.API_1484_11) {
                let progress = window.API_1484_11.GetValue(`cmi.objectives.${scoIndex}.progress_measure`);
                let completionStatus = window.API_1484_11.GetValue(`cmi.objectives.${scoIndex}.completion_status`);
                
                console.log(`ðŸ“Š Mini-Lesson ${scoIndex}: Progress = ${progress}, Status = ${completionStatus}`);
                
                return {
                    progress: progress ? parseFloat(progress) : 0,
                    status: completionStatus || "unknown"
                };
            }
            return null;
        }

        // Set progress tracking interval
        //document.addEventListener("DOMContentLoaded", function () {
            //console.log("Adding progress tracking interval.");
            //setInterval(trackProgress, 30000); // Track progress every 60 seconds
        //});       

        document.addEventListener("DOMContentLoaded", function () {
            console.log("Checking for saved progress...");

            const iframe = document.getElementById("scormContentIframe");

            window.savedLocation = "{{ saved_location|escapejs }}";
            window.savedScrollPosition = parseInt("{{ saved_scroll_position|escapejs }}", 10) || 0;

            if (window.savedLocation) {
                console.log(`Resuming at saved location: ${window.savedLocation}`);

                iframe.addEventListener("load", function () {
                    console.log(`Navigating to saved location: ${window.savedLocation}`);
                    iframe.contentWindow.location.href = window.savedLocation;

                    setTimeout(() => {
                        console.log(`Restoring scroll position: ${window.savedScrollPosition}`);
                        iframe.contentWindow.scrollTo(0, window.savedScrollPosition);
                    }, 1500); // âœ… Delay to ensure the content loads first
                });
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Automatically track progress every 30 seconds in case of updates
            setInterval(trackMiniLessonProgress, 30000); // Runs every 30 seconds

            console.log("Adding progress tracking interval.");
            setInterval(trackProgress, 30000); // Track progress every 30 seconds
            console.log("HEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE")

            if (iframe) {
                // Add the load event listener to track progress once iframe loads content
                iframe.addEventListener("load", function () {
                    const progress = getProgressFromIframe();
                    console.log(`Current Progress: ${progress * 100}%`);
                });

                // Log available iframe content (optional for debugging)
                if (iframe.contentWindow) {
                    console.log("iframe contentWindow properties:", Object.keys(iframe.contentWindow));
                }

                // Load event to handle specific SCORM interactions or content
                iframe.addEventListener("load", () => {
                    console.log("SCORM content iframe loaded");

                    try {
                        // Example of LMSProxy override (already in your script)
                        const iframeWindow = iframe.contentWindow;

                        if (iframeWindow && iframeWindow.LMSProxy) {
                            console.log("LMSProxy detected. Wrapping SetDataChunk...");

                            const originalSetDataChunk = iframeWindow.LMSProxy.SetDataChunk;

                            iframeWindow.LMSProxy.SetDataChunk = function (data) {
                                console.log("SetDataChunk called with data:", data);

                                // Process SetDataChunk data and extract progress (your existing logic)
                                if (data) {
                                    try {
                                        const parsedData = JSON.parse(data);
                                        console.log("Parsed SetDataChunk data:", parsedData);

                                        if (parsedData.totalSlides) {
                                            totalPages = parsedData.totalSlides;
                                            console.log("Total Slides Updated:", totalPages);
                                        }

                                        if (parsedData.currentSlide) {
                                            const currentPage = parsedData.currentSlide;
                                            pagesVisited.add(currentPage);
                                            console.log("Current Slide Visited:", currentPage);

                                            if (totalPages > 0) {
                                                const progress = pagesVisited.size / totalPages;
                                                window.API_1484_11.SetValue("cmi.progress_measure", progress.toFixed(2));
                                                console.log(`Progress Updated: ${progress}`);
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error parsing SetDataChunk data:", error);
                                    }
                                }

                                return originalSetDataChunk.apply(this, arguments);
                            };
                        } else {
                            console.warn("LMSProxy not found in iframe content.");
                        }
                    } catch (error) {
                        console.error("Error wrapping LMSProxy.SetDataChunk:", error);
                    }
                });
            } else {
                console.error("Iframe with ID 'scormContentIframe' not found.");
            }
        });

    </script>
</head>
<body>
    <div class="scorm-container">
        <iframe 
            id="scormContentIframe"
            src="{{ scorm_index_file_url }}"
            frameborder="0" 
            width="100%" 
            height="800px" 
            sandbox="allow-scripts allow-same-origin allow-forms"
            allowfullscreen>
        </iframe>
    </div>
</body>
</html>