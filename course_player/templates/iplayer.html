<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCORM Player</title>
    {% load static %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .lesson-item {
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .lesson-item.lesson-completed {
            background-color: #d4edda;
            font-weight: bold;
        }
        .sidebar-header {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .lesson-progress {
            float: right;
            font-size: 0.85em;
            color: #28a745;
        }
    </style>
</head>
<body>
    <script>
        const launchScormUrlTemplate = "{% url 'launch_scorm_file' 0 %}".replace("/0/", "/");
    
        function launchLessonById(lessonId) {
            window.location.href = launchScormUrlTemplate + lessonId + "/";
        }
    
        function launchNextLesson(nextLessonId) {
            launchLessonById(nextLessonId);
        }
    
        function launchPrevLesson(prevLessonId) {
            launchLessonById(prevLessonId);
        }
    </script>
    
<div class="container-fluid">
    <div class="row">
        <!-- SCORM iframe area -->
        <div class="col-md-9">
            <iframe id="scormContentIframe"
                    src="{{ lesson_location|default:scorm_index_file_url|escape }}"
                    frameborder="0"
                    width="100%"
                    height="1200px"
                    allowfullscreen>
            </iframe>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const iframe = document.getElementById("scormContentIframe");
                const intendedUrl = "{{ lesson_location|escapejs }}";
            
                // ✅ Force iframe to exact saved lesson location on load
                if (iframe && intendedUrl && iframe.src !== intendedUrl) {
                    console.log("⏩ Forcing iframe to saved lesson location:", intendedUrl);
                    iframe.src = intendedUrl;
                }
            });
        </script>    

        <!-- Sidebar area -->
        <div class="col-md-3 bg-light p-3">
            {% if prev_lesson %}
            <button id="prevLessonBtn" class="btn btn-secondary w-100 mb-3" onclick="launchPrevLesson({{ prev_lesson.id }})">
                Previous Lesson
            </button>
            {% endif %}

            {% if next_lesson %}
            <button id="nextLessonBtn" class="btn btn-primary w-100 mb-3" onclick="launchNextLesson({{ next_lesson.id }})">
                Next Lesson
            </button>
            {% else %}
            <button id="finishCourseBtn" class="btn btn-success w-100 mb-3" onclick="finishCourse()" style="display: none;">
                Finish Course
            </button>
            {% endif %}

            <div class="sidebar-header">Course Progress</div>
            <div class="progress mb-2">
                <div class="progress-bar" id="courseProgressBar" style="width: 0%;"></div>
            </div>
            <span id="courseProgressText">{{ user_course.progress|default:0 }}%</span>

            {{ lesson_progress_data|json_script:"lessonData" }}

            <div id="lessonList" class="mt-3">
                {% for lesson in all_lessons %}
                <div class="lesson-item py-2" data-lesson-id="{{ lesson.id }}" onclick="launchLessonById({{ lesson.id }})">
                    {{ lesson.title }}
                </div>                
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
    window.progressDataString = '{{ lesson_progress_data|default:"[]"|escapejs }}';
    window.lessonId = {{ lesson.id|default:"0" }};
    window.userId = {{ profile_id|default:"0" }};
    window.courseLocked = {{ course_locked|yesno:"true,false" }};
    window.miniLessonProgress = {{ mini_lesson_progress|default:"[]"|safe }};
    window.lessonContentType = "{{ lesson.content_type }}";
    window.lessonLocation = "{{ lesson.lesson_location }}";

    document.addEventListener("DOMContentLoaded", function () {
        try {
            const rawData = document.getElementById('lessonData').textContent;
            const parsedData = JSON.parse(rawData);
            window.lessonData = parsedData;

            document.querySelectorAll('.lesson-item').forEach(item => {
                const id = parseInt(item.dataset.lessonId);
                const lesson = parsedData.find(l => l.id === id);

                if (lesson?.completed) {
                    item.classList.add("lesson-completed");
                }

                if (lesson?.progress != null) {
                    const progressText = document.createElement('span');
                    progressText.className = 'lesson-progress';
                    progressText.textContent = `${lesson.progress}%`;
                    item.appendChild(progressText);
                }
            });
        } catch (e) {
            console.warn("Failed to update sidebar lesson progress:", e);
        }
    });
</script>
<script src="{% static 'course_player/javascript/scorm_player.js' %}?v=2"></script>
</body>
</html>