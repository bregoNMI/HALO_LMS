<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    {% load static %}
    
    <!-- Testing HTML Rendering -->
    <p>If you can see this text, the HTML is rendering correctly.</p>
    <p>Signed URL: {{ scorm_index_file_url }}</p>

    <!-- Include the SCORM API JavaScript wrapper -->
    <script src="{% static 'course_player/javascript/SCORM_API_wrapper.js' %}?v=2"></script>

    <script>
        console.log("iplayer.html script loaded");

        // Define the global lesson ID and user ID
        window.lessonId = "{{ lesson.id }}";
        window.userId = "{{ request.user.id }}";
        // Ensure SCORM API is available globally
        window.API_1484_11 = window.API_1484_11 || {
            Initialize: () => {
                console.log("SCORM API: Initialize called");
                return "true";
            },
            Terminate: () => {
                console.log("SCORM API: Terminate called");
                return "true";
            },
            GetValue: (key) => {
                console.log(`SCORM API: GetValue called for key: ${key}`);
                return "";
            },
            SetValue: (key, value) => {
                console.log(`SCORM API: SetValue called for key: ${key}, value: ${value}`);
                return "true";
            },
            Commit: () => {
                console.log("SCORM API: Commit called");
                return "true";
            },
            SetPassed: () => {
                console.log("SCORM API: SetPassed called");
                return "true";
            },
            GetLastError: () => "0",
            GetErrorString: (errorCode) => "No error",
            GetDiagnostic: (errorCode) => "",
        };

        // This function allows SCORM content to find the API
        window.GetAPI = function () {
            console.log("Providing SCORM API to SCORM package.");
            return window.API_1484_11 || null;
        };

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function sendTrackingData(trackingData) {
            console.log("Preparing to send tracking data:", trackingData);
            if (!trackingData.lesson_id) {
                console.error("lesson_id is missing from tracking data!");
                return;
            }
            try {
                const response = await fetch('/course_player/track-scorm-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(trackingData),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Successfully tracked SCORM data:', data);
            } catch (error) {
                console.error('Error tracking SCORM data:', error);
            }
        }

        // Function to test sending tracking data manually
        function sendTestTrackingData() {
            const trackingData = {
                lesson_id: window.lessonId,
                user_id: window.userId,
                parameter: "test.param",
                value: "test.value"
            };
            console.log("Sending test tracking data...");
            sendTrackingData(trackingData);
        }

        // Override SCORM API methods to log their interactions and send tracking data
        document.addEventListener("DOMContentLoaded", function() {
            console.log("Adding overrides to SCORM API methods.");
            const originalSetValue = window.API_1484_11.SetValue;
            window.API_1484_11.SetValue = (key, value) => {
                console.log(`SetValue intercepted - Key: ${key}, Value: ${value}`);
                const result = originalSetValue(key, value);
                if (result === "true") {
                    sendTrackingData({
                        lesson_id: window.lessonId,
                        user_id: window.userId,
                        parameter: key,
                        value: value
                    });
                }
                return result;
            };

            const originalCommit = window.API_1484_11.Commit;
            window.API_1484_11.Commit = () => {
                console.log("Commit intercepted");
                const result = originalCommit();
                if (result === "true") {
                    sendTrackingData({
                        lesson_id: window.lessonId,
                        user_id: window.userId,
                        action: "commit",
                    });
                }
                return result;
            };
        });

    </script>    
</head>
<body>
    <div class="scorm-container">
        <iframe 
            id="scormContentIframe"
            src="{{ scorm_index_file_url }}"
            frameborder="0" 
            width="100%" 
            height="800px" 
            allowfullscreen>
        </iframe>
    </div>
    <button onclick="sendTestTrackingData()">Test SCORM Tracking</button>
</body>
</html>