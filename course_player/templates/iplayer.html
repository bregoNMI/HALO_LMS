<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    {% load static %}
    
    <!-- Testing HTML Rendering -->
    <p>If you can see this text, the HTML is rendering correctly.</p>

    <!-- Include the SCORM API JavaScript wrapper -->
    <script src="{% static 'course_player/javascript/SCORM_API_wrapper.js' %}?v=2"></script>

    <script>
        console.log("iplayer.html script loaded");

        // Define the global lesson ID and user ID
        window.lessonId = "{{ lesson.id }}";
        window.userId = "{{ request.user.id }}";

        try {
            let attempts = 0;
            let maxAttempts = 500;
            let win = window;
            let API = null;

            console.log("Attempting to find SCORM API (`API_1484_11`) in parent window...");

            // Traverse through parent frames to locate the SCORM API
            while (!API && attempts < maxAttempts) {
                attempts++;
                if (win.parent && win.parent != win) {
                    win = win.parent;
                    console.log(`Attempt ${attempts}: Searching for SCORM API in parent frame...`);
                    
                    if (win.API_1484_11) {
                        console.log("API_1484_11 found in parent frame after " + attempts + " attempts.");
                        API = win.API_1484_11;
                        break;
                    }
                } else {
                    break;
                }
            }

            if (API) {
                console.log("Successfully found the SCORM API (`API_1484_11`) in parent frame.");
            } else {
                console.error("Unable to find the SCORM API (`API_1484_11`) in any parent frames.");
            }
        } catch (e) {
            console.error("Cross-origin issue while trying to access parent frame:", e);
        }

        // SCORM API global object
        var API;
        window.API = API;

        pipwerks.SCORM.version = "2004";

        document.addEventListener("DOMContentLoaded", function () {
            // Set SCORM version, assuming it is SCORM 1.2 in this example
            pipwerks.SCORM.version = "2004";

            if (typeof pipwerks !== 'undefined' && pipwerks.SCORM) {
                console.log("pipwerks SCORM API successfully loded.");

                // Create the SCORM API object
                API = pipwerks.SCORM;

                // Check if API is found
                console.log("Attempting to get API...");
                var api = API.API.getHandle();
                if (api) {
                    console.log("API found successfully.");

                    // Initialize SCORM API
                    const initialized = pipwerks.SCORM.connection.initialize();
                    if (initialized) {
                        console.log("SCORM API initialized successfully.");
                    } else {
                        console.error("SCORM API initialization failed. The SCORM package might not be in an LMS.");
                    }
                } else {
                    console.warn("No LMS API found. The course may not be running in an LMS.");
                }
            } else {
                console.error("pipwerks SCORM API failed to load. Check the script source.");
            }
        });

        function findAPI(win) {
            let attempts = 0;
            while ((!win.API_1484_11 && !win.API) &&
                (win.parent != null) &&
                (win.parent != win) &&
                (attempts <= 500)) {
                attempts++;
                win = win.parent;
            }
            return win.API_1484_11 || win.API || null;
        }


        // This function allows SCORM content to find the API
        function GetAPI() {
            console.log("GetAPI function called");
            if (typeof API !== 'undefined' && API !== null) {
                console.log("Returning SCORM API object from GetAPI function.");
            } else {
                console.error("GetAPI: SCORM API object is not defined.");
            }
            return API;
        }

        // Make sure GetAPI is in the global scope
        window.GetAPI = GetAPI;

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function sendTrackingData(trackingData) {
            console.log("Preparing to send tracking data:", trackingData);
            try {
                const response = await fetch('/track-scorm-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(trackingData)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Successfully tracked SCORM data:', data);
            } catch (error) {
                console.error('Error tracking SCORM data:', error);
            }
        }

        // Function to test sending tracking data manually
        function sendTestTrackingData() {
            const trackingData = {
                lesson_id: window.lessonId,
                user_id: window.userId,
                parameter: "test.param",
                value: "test.value"
            };
            console.log("Sending test tracking data...");
            sendTrackingData(trackingData);
        }

        // Override SCORM API methods to log their interactions and send tracking data
        document.addEventListener("DOMContentLoaded", function() {
            if (API) {
                console.log("Adding overrides to SCORM API methods.");
                API.set = function(parameter, value) {
                    console.log(`SCORM set called with parameter: ${parameter}, value: ${value}`);
                    var result = pipwerks.SCORM.set(parameter, value);
                    if (result) {
                        console.log("SCORM set successful, sending tracking data...");
                        var trackingData = {
                            lesson_id: window.lessonId,
                            user_id: window.userId,
                            parameter: parameter,
                            value: value
                        };
                        sendTrackingData(trackingData);
                    } else {
                        console.log("SCORM set failed");
                    }
                    return result;
                };

                API.finish = function() {
                    console.log("SCORM finish called");
                    var result = pipwerks.SCORM.finish();
                    if (result) {
                        console.log("SCORM finish successful, sending completion data...");
                        var completionData = {
                            lesson_id: window.lessonId,
                            user_id: window.userId,
                            completion_status: pipwerks.SCORM.get('cmi.core.lesson_status'),
                            score: pipwerks.SCORM.get('cmi.core.score.raw')
                        };
                        sendTrackingData(completionData);
                    } else {
                        console.log("SCORM finish failed");
                    }
                    return result;
                };
            } else {
                console.error("API is not defined. Cannot add overrides.");
            }
        });

    </script>    
</head>
<body>
    <div class="scorm-container">
        <iframe 
            id="scormContentIframe"
            src="{{ scorm_index_file_url }}"
            frameborder="0" 
            width="100%" 
            height="800px" 
            allowfullscreen>
        </iframe>
    </div>
    <button onclick="testScormInit()">Test SCORM Initialization</button>
    <script>
        function testScormInit() {
            console.log("Testing SCORM API initialization...");
            var initialized = pipwerks.SCORM.connection.initialize();
            if (initialized) {
                console.log("SCORM initialized successfully.");
            } else {
                console.error("Failed to initialize SCORM.");
            }
        }
    </script>

    <script>
        // Assuming that the LMS is supposed to provide this API for SCORM 2004
        window.API_1484_11 = {
            Initialize: function () {
                console.log("Initializing SCORM 2004...");
                return "true"; // Stub return value for now
            },
            // Add other required SCORM methods like `GetValue`, `SetValue`, etc.
        };
    </script>


</body>
</html>
