<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    {% load static %}
    
    <p>If you can see this text, the HTML is rendering correctly.</p>
    <p>Signed URL: {{ scorm_index_file_url }}</p>

    <!-- Include the SCORM API JavaScript wrapper -->
    <script src="{% static 'course_player/javascript/SCORM_API_wrapper.js' %}?v=2"></script>

    <script>
        console.log("iplayer.html script loaded");

        // Define the global lesson ID and user ID
        window.lessonId = "{{ lesson.id }}";
        window.userId = "{{ profile_id }}";

        let totalPages = 0;
        let pagesVisited = new Set();

        console.log("Profile ID:", window.userId);

        // Initialize session start time globally
        let sessionStartTime = new Date();

        // Ensure SCORM API is available globally
        window.API_1484_11 = window.API_1484_11 || {
            Initialize: () => {
                console.log("SCORM API: Initialize called");
                sessionStartTime = new Date(); // Set the session start time
                return "true";
            },
            Terminate: () => {
                console.log("SCORM API: Terminate called");
                return "true";
            },
            GetValue: (key) => {
                console.log(`SCORM API: GetValue called for key: ${key}`);
                
                // Retrieve from mock data store
                return this.dataStore ? this.dataStore[key] || "" : "";
            },
            SetValue: (key, value) => {
                console.log(`SCORM API: SetValue called for key: ${key}, value: ${value}`);
                
                // Persist progress measure in a mock data store
                if (!this.dataStore) {
                    this.dataStore = {}; // Create a mock data store if it doesn't exist
                }
                this.dataStore[key] = value; // Store the key-value pair

                return "true";
            },
            Commit: () => {
                console.log("SCORM API: Commit called");
                return "true";
            },
            SetBookmark: () => {
                console.log("SCORM API: SetBookmark called");
                return "true";
            },
            CommitData: () => {
                console.log("SCORM API: CommitData called");
                return "true";
            },
            GetLastError: () => "0",
            GetErrorString: (errorCode) => "No error",
            GetDiagnostic: (errorCode) => "",
        };

        // Function to calculate session time
        function getSessionTime() {
            const now = new Date();
            const duration = Math.floor((now - sessionStartTime) / 1000); // Duration in seconds

            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;

            return `PT${hours}H${minutes}M${seconds}S`;
        }

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getTotalPagesFromIframe() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe && iframe.contentWindow) {
                try {
                    const iframeDocument = iframe.contentWindow.document;

                    // Adjust selectors to match the structure of your SCORM content
                    const slides = iframeDocument.querySelectorAll(".slide, .page"); // Example selectors
                    console.log("Slides Found:", slides.length);

                    return slides.length;
                } catch (error) {
                    console.error("Unable to access iframe content:", error);
                }
            }
            return 0; // Default fallback if pages are not found
        }

        function updateTotalPages() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe) {
                iframe.addEventListener("load", () => {
                    totalPages = getTotalPagesFromIframe();
                    console.log("Total Pages Updated:", totalPages); // Display total pages in the console
                });
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateTotalPages(); // Initialize the process to count total pages
        });

        // Function to send SCORM tracking data to the server
        async function sendTrackingData(trackingData) {
            console.log("Preparing to send tracking data:", trackingData);

            try {
                const response = await fetch('/course_player/track-scorm-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(trackingData),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Successfully tracked SCORM data:", data);
            } catch (error) {
                console.error("Error tracking SCORM data:", error);
            }
        }

        //function updateProgress(currentPage) {
            // Add current page to visited set
            //pagesVisited.add(currentPage);

            //if (totalPages > 0) {
                //const progress = pagesVisited.size / totalPages;
                //window.API_1484_11.SetValue("cmi.progress_measure", progress.toFixed(2));
                //console.log(`Progress Updated: ${progress}`);
                //trackProgress();
            //}
        //}

        function trackProgress() {
            try {

                const simulatedProgress = parseFloat(window.API_1484_11.GetValue("cmi.progress_measure")) || 0;
                const increment = 0.1; // Example: Increase by 10% per interval
                const newProgress = Math.min(simulatedProgress + increment, 1); // Ensure progress does not exceed 1 (100%)

                // Update the SCORM API progress measure
                window.API_1484_11.SetValue("cmi.progress_measure", newProgress.toString());

                const progressMeasure = window.API_1484_11.GetValue('cmi.progress_measure'); // Progress as a decimal
                console.log(`Progress Measure After Update: ${progressMeasure}`);

                let completionStatus = window.API_1484_11.GetValue('cmi.completion_status') || "incomplete";
                const score = window.API_1484_11.GetValue('cmi.score.raw');
                const sessionTime = getSessionTime();

                if (parseFloat(progressMeasure) === 1) {
                    completionStatus = "complete";
                    window.API_1484_11.SetValue("cmi.completion_status", completionStatus);
                    console.log("Completion Status Updated to: complete");
                }

                console.log(`Progress Measure: ${newProgress}`);
                console.log(`Completion Status: ${completionStatus}`);
                console.log(`Score: ${score}`);
                console.log(`Session Time: ${sessionTime}`);

                // Avoid redundant calls unless there's a change
                if (
                    progressMeasure !== lastProgress ||
                    completionStatus !== lastCompletionStatus ||
                    sessionTime !== lastSessionTime ||
                    score !== lastScore
                ) {
                    lastProgress = progressMeasure;
                    lastCompletionStatus = completionStatus;
                    lastSessionTime = sessionTime;
                    lastScore = score;

                    sendTrackingData({
                        lesson_id: window.lessonId,
                        user_id: window.userId,
                        progress: parseFloat(progressMeasure) || 0, // Send as a decimal value
                        completion_status: completionStatus,
                        session_time: sessionTime,
                        score: parseFloat(score) || null,
                    });
                }
            } catch (error) {
                console.error("Error tracking progress:", error);
            }
        }

        // Set progress tracking interval
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Adding progress tracking interval.");
            setInterval(trackProgress, 30000); // Track progress every 60 seconds
        });
    </script>
</head>
<body>
    <div class="scorm-container">
        <iframe 
            id="scormContentIframe"
            src="{{ scorm_index_file_url }}"
            frameborder="0" 
            width="100%" 
            height="800px" 
            allowfullscreen>
        </iframe>
    </div>
</body>
</html>