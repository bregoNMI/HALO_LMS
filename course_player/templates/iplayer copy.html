<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    {% load static %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


    <style>
        /* Sidebar Styling */
        .right-sidebar {
            background-color: #f8f9fa;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .sidebar-header {
            font-size: 1.2rem;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }

        .lesson-item {
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .lesson-item:hover {
            background: #e2e6ea;
            cursor: pointer;
        }

        .lesson-completed {
            color: green;
            font-weight: bold;
        }

        .progress-bar-container {
            width: 100%;
            background: #ddd;
            border-radius: 5px;
            height: 5px;
            margin-top: 5px;
        }

        .lesson-item.current-lesson {
            background-color: #007bff;
            color: white !important;  /* Add !important if necessary */
            font-weight: bold;
        }

        .lesson-item.locked {
            color: gray;
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.5;
        }

        .progress-bar {
            height: 5px;
            border-radius: 5px;
            background: #28a745;
        }

        .course-progress-bar-container {
            width: 100%;
            background: #ddd;
            border-radius: 5px;
            height: 10px;
            margin-top: 10px;
            position: relative;
        }

        .course-progress-bar {
            height: 10px;
            border-radius: 5px;
            background: #28a745;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .lesson-item.locked {
            color: gray;
            cursor: not-allowed;
            pointer-events: none; /* Prevents clicking */
            opacity: 0.5; /* Make it look disabled */
        }
    </style>
    
    <p>If you can see this text, the HTML is rendering correctly.</p>
    <p>Signed URL: {{ scorm_index_file_url }}</p>

    <!-- Include the SCORM API JavaScript wrapper -->
    <script src="{% static 'course_player/javascript/SCORM_API_wrapper.js' %}?v=2"></script>
    {{ lesson_progress_data|json_script:"lessonData" }}
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const lessonData = JSON.parse(document.getElementById('lessonData').textContent);
        console.log("Lesson Data Parsed:", lessonData);

        document.querySelectorAll('.lesson-item').forEach(item => {
            const lessonId = parseInt(item.getAttribute('data-lesson-id'));
            const data = lessonData.find(l => l.id === lessonId);

            console.log(`Checking lesson ID ${lessonId}: Locked = ${data?.locked}`);

            if (data && data.locked) {
                item.classList.add('locked');
                item.innerHTML = '<i class="fas fa-lock"></i> ' + item.innerHTML;
            }
        });
    });
    </script>

    <script>
        console.log("iplayer.html script loaded");

        // Define the global lesson ID and user ID
        window.lessonId = "{{ lesson.id }}";
        window.userId = "{{ profile_id }}";
        window.savedLocation = "{{ lesson_location|escapejs }}"; // Passed from Django
        window.savedProgress = parseFloat("{{ saved_progress }}") || 0;
        window.savedScrollPosition = parseInt("{{ saved_scroll_position|escapejs }}", 10) || 0;
        let progressDataString = '{{ mini_lesson_progress|default:"[]"|escapejs }}';
        let progressData;

        try {
            progressData = JSON.parse(progressDataString);
        } catch (error) {
            console.error("JSON parsing error for mini_lesson_progress:", error, progressDataString);
            progressData = []; // Fallback to empty array
        }

        try {
            progressData = progressDataString ? JSON.parse(progressDataString) : [];
        } catch (error) {
            console.error("JSON parsing error for mini_lesson_progress:", error);
            progressData = []; // Fallback to empty array
        }

        console.log("Progress Data Loaded:", progressData);

        let totalPages = 0;
        let pagesVisited = new Set();

        console.log("Profile ID:", window.userId);

        // Initialize session start time globally
        let sessionStartTime = new Date();

        // Ensure SCORM API is available globally
        window.API_1484_11 = window.API_1484_11 || {
            Initialize: () => {
                console.log("SCORM API: Initialize called");
                sessionStartTime = new Date(); // Set the session start time
                return "true";
            },
            Terminate: () => {
                console.log("SCORM API: Terminate called");
                return "true";
            },
            GetValue: (key) => {
                console.log(`SCORM API: GetValue called for key: ${key}`);
                
                // Retrieve from mock data store
                return this.dataStore ? this.dataStore[key] || "" : "";
            },
            SetValue: (key, value) => {
                console.log(`SCORM API: SetValue called for key: ${key}, value: ${value}`);
                
                // Persist progress measure in a mock data store
                if (!this.dataStore) {
                    this.dataStore = {}; // Create a mock data store if it doesn't exist
                }
                this.dataStore[key] = value; // Store the key-value pair

                return "true";
            },
            Commit: () => {
                console.log("SCORM API: Commit called");
                return "true";
            },
            SetBookmark: () => {
                console.log("SCORM API: SetBookmark called");
                return "true";
            },
            CommitData: () => {
                console.log("SCORM API: CommitData called");
                return "true";
            },
            GetLastError: () => "0",
            GetErrorString: (errorCode) => "No error",
            GetDiagnostic: (errorCode) => "",
        };

        // Function to calculate session time
        function getSessionTime() {
            const now = new Date();
            const duration = Math.floor((now - sessionStartTime) / 1000); // Duration in seconds

            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;

            return `PT${hours}H${minutes}M${seconds}S`;
        }

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getTotalPagesFromIframe() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe && iframe.contentWindow) {
                try {
                    const iframeDocument = iframe.contentWindow.document;

                    // Adjust selectors to match the structure of your SCORM content
                    const slides = iframeDocument.querySelectorAll(".slide, .page"); // Example selectors
                    console.log("Slides Found:", slides.length);

                    return slides.length;
                } catch (error) {
                    console.error("Unable to access iframe content:", error);
                }
            }
            return 0; // Default fallback if pages are not found
        }

        function updateTotalPages() {
            const iframe = document.getElementById("scormContentIframe");
            if (iframe) {
                iframe.addEventListener("load", () => {
                    totalPages = getTotalPagesFromIframe();
                    console.log("Total Pages Updated:", totalPages); // Display total pages in the console
                });
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateTotalPages(); // Initialize the process to count total pages
        });

        document.addEventListener("DOMContentLoaded", function () {
            const currentLessonId = parseInt(window.lessonId);
            console.log("ðŸ” Highlighting current lesson ID:", currentLessonId);

            const lessonData = JSON.parse(document.getElementById('lessonData').textContent);
            console.log("Lesson Data:", lessonData);

            document.querySelectorAll('.lesson-item').forEach(item => {
                const lessonId = parseInt(item.getAttribute('data-lesson-id'));
                const lessonInfo = lessonData.find(l => l.id === lessonId);

                if (lessonId === currentLessonId) {
                    console.log(`âœ… Highlighting current lesson: ${lessonId}`);
                    item.classList.add('current-lesson');
                }

                if (lessonInfo && lessonInfo.locked) {
                    item.classList.add('locked');
                    item.innerHTML = '<i class="fas fa-lock"></i> ' + item.textContent.trim();
                }
            });
        });
        
        document.addEventListener("DOMContentLoaded", function () {
            const courseLocked = {{ course_locked|yesno:"true,false" }};  // Render as true/false
            console.log("ðŸ”’ Course Locked:", courseLocked);

            if (courseLocked) {
                // Lock all lessons except the current one
                const urlPath = window.location.pathname;
                const match = urlPath.match(/\/launch_scorm_file\/(\d+)\//);
                const currentLessonId = match ? parseInt(match[1]) : null;

                document.querySelectorAll('.lesson-item').forEach(item => {
                    const lessonId = parseInt(item.getAttribute('data-lesson-id'));
                    if (lessonId !== currentLessonId) {
                        item.classList.add('locked');
                        item.innerHTML = '<i class="fas fa-lock"></i> ' + item.innerHTML;
                    } else {
                        console.log("ðŸ”“ Current lesson remains unlocked:", lessonId);
                    }
                });
            }
        });
        
        function trackScrollPosition() {
            try {
                var iframe = document.getElementById("scormContentIframe");
                if (iframe && iframe.contentWindow) {
                    var scrollPos = iframe.contentWindow.scrollY || iframe.contentWindow.document.documentElement.scrollTop || iframe.contentWindow.document.body.scrollTop || 0;

                    console.log("Captured Scroll Position:", scrollPos);

                    if (window.API_1484_11) {
                        window.API_1484_11.SetValue("cmi.suspend_data", JSON.stringify({ scrollPos }));
                        window.API_1484_11.Commit();
                    }
                }
            } catch (error) {
                console.error("Error tracking scroll position:", error);
            }
        }

        // Track scroll every 5 seconds
        setInterval(trackScrollPosition, 5000);
        /*
        function trackProgress() {
            try {
                console.log("Attempting to track progress...");
                const iframe = document.getElementById("scormContentIframe");
                
                if (!iframe || !iframe.contentWindow) {
                    console.error("SCORM iframe not found.");
                    return;
                }

                const progressMeasure = getProgressFromIframe();
                const lessonLocation = iframe.contentWindow.location.href;
                const scrollPosition = iframe.contentWindow.document.documentElement.scrollTop || 
                            iframe.contentWindow.document.body.scrollTop || 
                            iframe.contentWindow.scrollY || 
                            0;
                
                //let scrollPosition = getScrollPosition();
                window.API_1484_11.SetValue("cmi.scroll_position", scrollPosition.toString());

                console.log("ðŸš€ Scroll Position Read:", {
                    documentElementScroll: iframe.contentWindow.document.documentElement.scrollTop,
                    bodyScroll: iframe.contentWindow.document.body.scrollTop,
                    scrollY: iframe.contentWindow.scrollY,
                    finalScrollPosition: scrollPosition
                });

                if (progressMeasure > 0) {
                    window.API_1484_11.SetValue("cmi.progress_measure", progressMeasure.toFixed(2));
                    window.API_1484_11.SetValue("cmi.location", lessonLocation);
                    window.API_1484_11.SetValue("cmi.scroll_position", scrollPosition.toString());

                    console.log(`Progress: ${progressMeasure}, Location: ${lessonLocation}, Scroll: ${scrollPosition}`);

                    sendTrackingData({
                        lesson_id: window.lessonId,
                        user_id: window.userId,
                        progress: progressMeasure,
                        lesson_location: lessonLocation,
                        scroll_position: scrollPosition,  
                        completion_status: progressMeasure === 1 ? "complete" : "incomplete",
                        session_time: getSessionTime(),
                        score: null,
                        cmi_data: JSON.stringify({
                            progress_measure: progressMeasure,
                            lesson_location: lessonLocation,
                            scroll_position: scrollPosition,
                        }) // âœ… Send structured SCORM data
                    });

                } else {
                    console.warn("Progress measure not found or is 0.");
                }
            } catch (error) {
                console.error("Error tracking progress:", error);
            }
        }
        */
        window.addEventListener("message", function(event) {
            if (event.data.type === "getScrollPosition") {
                var scrollPos = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop;
                console.log("ðŸ“Œ SCORM Sending Scroll Position:", scrollPos);
                
                // ðŸ”¹ Send scroll position back to LMS
                window.parent.postMessage({ type: "scrollPositionResponse", scrollPos: scrollPos }, "*");
            }
        });

        function trackProgress() {
            try {
                console.log("Attempting to track progress...");
                const iframe = document.getElementById("scormContentIframe");

                if (!iframe || !iframe.contentWindow) {
                    console.error("SCORM iframe not found.");
                    return;
                }

                const progressMeasure = getProgressFromIframe();
                const lessonLocation = iframe.contentWindow.location.href;

                // ðŸ”¹ Wait for SCORM to send back the scroll position
                window.addEventListener("message", function(event) {
                    if (event.data.type === "scrollPositionResponse") {
                        let scrollPosition = event.data.scrollPos;
                        
                        var scrollPos = window.scrollY;
                        console.log("ðŸ“Œ SCORM Saving Scroll Position:", scrollPos);

                        // Store scroll position in SCORM API
                        window.API_1484_11.SetValue("cmi.scroll_position", scrollPosition.toString());

                        if (progressMeasure > 0) {
                            window.API_1484_11.SetValue("cmi.progress_measure", progressMeasure.toFixed(2));
                            window.API_1484_11.SetValue("cmi.location", lessonLocation);
                            window.API_1484_11.SetValue("cmi.scroll_position", scrollPosition.toString());

                            console.log(`Progress: ${progressMeasure}, Location: ${lessonLocation}, Scroll: ${scrollPosition}`);

                            sendTrackingData({
                                lesson_id: window.lessonId,
                                user_id: window.userId,
                                progress: progressMeasure,
                                lesson_location: lessonLocation,
                                scroll_position: scrollPosition,  
                                completion_status: progressMeasure === 1 ? "complete" : "incomplete",
                                session_time: getSessionTime(),
                                score: null,
                                cmi_data: JSON.stringify({
                                    progress_measure: progressMeasure,
                                    lesson_location: lessonLocation,
                                    scroll_position: scrollPosition,
                                }) // âœ… Send structured SCORM data
                            });
                        } else {
                            console.warn("Progress measure not found or is 0.");
                        }
                    }
                });

            } catch (error) {
                console.error("Error tracking progress:", error);
            }
        }
        
        function sendTrackingData(trackingData) {
            console.log("ðŸ“¡ Sending SCORM tracking data to server...");

            fetch('/course_player/track-scorm-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(trackingData),
            })
            .then(response => response.json())
            .then(data => console.log("âœ… SCORM progress updated:", trackingData))
            .catch(error => console.error("ðŸš¨ Error tracking SCORM data:", error));
        }
        
        function sendMiniLessonProgress(lessonProgressArray) {
            console.log("ðŸ“¡ Sending mini-lesson progress to server...", lessonProgressArray);

            fetch('/course_player/track-mini-lesson-progress/', {  // New API endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    user_id: window.userId,
                    lesson_progress: lessonProgressArray
                }),
            })
            .then(response => response.json())
            .then(data => console.log("âœ… Mini-lesson progress updated:", data))
            .catch(error => console.error("ðŸš¨ Error tracking mini-lesson progress:", error));
        }

        function waitForSCORMUI(callback) {
            let iframe = document.getElementById("scormContentIframe");
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.warn("âš ï¸ SCORM iframe not found. Retrying in 2 seconds...");
                setTimeout(() => waitForSCORMUI(callback), 2000);
                return;
            }

            let iframeDocument = iframe.contentWindow.document;
            let progressCircles = iframeDocument.querySelectorAll("svg.progress-circle--sidebar");

            if (progressCircles.length > 0) {
                console.log("âœ… SCORM Progress Circles Found:", progressCircles);
                callback(iframe);
            } else {
                console.warn("âš ï¸ SCORM UI not fully loaded yet. Retrying...");
                setTimeout(() => waitForSCORMUI(callback), 2000);
            }
        }

        function waitForSCORMIframe(callback, attempts = 10) {
            let iframe = document.getElementById("scormContentIframe");
            if (iframe && iframe.contentWindow && iframe.contentWindow.document) {
                console.log("âœ… SCORM iframe is now accessible.");
                callback(iframe);
            } else if (attempts > 0) {
                console.warn(`âš ï¸ SCORM iframe not ready yet. Retrying... (${attempts} attempts left)`);
                setTimeout(() => waitForSCORMIframe(callback, attempts - 1), 1000);
            } else {
                console.error("âŒ SCORM iframe could not be accessed after multiple attempts.");
            }
        }

        function restoreScrollPosition() {
            try {
                var suspendData = window.API_1484_11.GetValue("cmi.suspend_data");
                if (suspendData) {
                    var parsedData = JSON.parse(suspendData);
                    var savedScrollPos = parsedData.scrollPos || 0;

                    let iframe = document.getElementById("scormContentIframe");

                    // Retry scroll restoration after content loads
                    const tryScrollRestore = (attempts = 5) => {
                        if (iframe && iframe.contentWindow && iframe.contentWindow.document.readyState === "complete") {
                            iframe.contentWindow.scrollTo(0, savedScrollPos);
                            console.log("âœ… Scroll position restored to:", savedScrollPos);
                        } else if (attempts > 0) {
                            console.log("âš ï¸ Iframe not ready for scroll. Retrying...");
                            setTimeout(() => tryScrollRestore(attempts - 1), 1000);
                        } else {
                            console.warn("âŒ Failed to restore scroll position after retries.");
                        }
                    };

                    tryScrollRestore();
                }
            } catch (error) {
                console.error("Error restoring scroll position:", error);
            }
        }

        function updateSCORMProgress(iframe) {
            let iframeDocument = iframe.contentWindow.document;
            let sidebarItems = iframeDocument.querySelectorAll("svg.progress-circle--sidebar");

            if (!sidebarItems.length) {
                console.warn("âš ï¸ No sidebar progress circles found inside SCORM iframe. Retrying...");
                //setTimeout(() => updateSCORMProgress(iframe), 2000);
                return;
            }

            console.log("âœ… Found Sidebar Progress Elements in SCORM iframe:", sidebarItems);

            let miniLessonProgress = JSON.parse('{{ mini_lesson_progress|safe }}'.replace(/'/g, '"'));
            console.log("ðŸ“Š Extracted Lesson Progress Data:", miniLessonProgress);

            miniLessonProgress.forEach((miniLesson, index) => {
                let { mini_lesson_index, progress } = miniLesson;

                if (mini_lesson_index >= sidebarItems.length) {
                    console.warn(`âš ï¸ Skipping mini-lesson ${mini_lesson_index} (No matching sidebar item found)`);
                    return;
                }

                let sidebarItem = sidebarItems[mini_lesson_index];

                if (sidebarItem) {
                    console.log(`ðŸ”„ Processing sidebar item ${mini_lesson_index} with progress: ${progress}`);

                    let progressCircle = sidebarItem.querySelector("circle.progress-circle__runner, circle");
                    let checkmark = sidebarItem.querySelector("path.progress-circle__pass");

                    // Extract progress percentage (e.g., "23% Completed" â†’ 23)
                    let progressPercentage = parseFloat(progress.replace("% Completed", "").trim()) || 0;

                    // Calculate stroke-dashoffset for outer circle
                    let totalStroke = 43.982297150257104;
                    let strokeOffset = totalStroke * (1 - (progressPercentage / 100));

                    if (progressCircle) {
                        console.log(`ðŸ”„ Setting progress circle for mini-lesson ${mini_lesson_index} to ${progressPercentage}%`);
                        
                        // Apply stroke offset
                        progressCircle.setAttribute("stroke-dashoffset", strokeOffset);
                        progressCircle.style.transition = "stroke-dashoffset 0.5s ease-in-out";
                        
                        // Force reapply after SCORM loads
                        setTimeout(() => {
                            progressCircle.setAttribute("stroke-dashoffset", strokeOffset);
                        }, 1000);
                    }

                    // Check if lesson is fully completed
                    if (progress === "Completed") {
                        console.log(`âœ… Marking lesson ${mini_lesson_index} as completed.`);

                        if (progressCircle) {
                            progressCircle.setAttribute("stroke-dashoffset", "0");
                            progressCircle.classList.add("progress-circle__runner--completed");
                            progressCircle.style.fill = "#162c53"; // Ensure full completion color
                        }

                        if (checkmark) {
                            console.log(`âœ… Showing checkmark for lesson ${mini_lesson_index}`);
                            checkmark.style.display = "block";
                            checkmark.style.opacity = "1";
                            checkmark.style.visibility = "visible";
                        }
                    } else {
                        console.log(`ðŸš« Lesson ${mini_lesson_index} is not fully completed, hiding checkmark.`);
                        if (checkmark) {
                            checkmark.style.display = "none";
                            checkmark.style.opacity = "0";
                            checkmark.style.visibility = "hidden";
                        }
                    }
                }
            });

            // **Force UI Refresh**
            if (iframeDocument.body) {
                iframeDocument.body.style.display = "none";
                setTimeout(() => {
                    iframeDocument.body.style.display = "";
                    console.log("ðŸ”„ SCORM UI refreshed to apply changes.");
                }, 500);
            }
        }

        function observeSCORMChanges(iframe) {
            let iframeDocument = iframe.contentWindow.document;
            let observer = new MutationObserver(() => {
                console.log("ðŸ”„ SCORM UI updated, ensuring progress circles stay correct...");
                updateSCORMProgress(iframe);
            });

            observer.observe(iframeDocument.body, {
                childList: true,
                subtree: true
            });
        }

        waitForSCORMIframe((iframe) => {
            updateSCORMProgress(iframe);
            //observeSCORMChanges(iframe);
            updateProgressCircles();
        });

        function updateProgressCircles() {
            let iframe = document.getElementById("scormContentIframe");
            if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
                console.warn("âš ï¸ SCORM iframe not fully loaded. Retrying in 2 seconds...");
                setTimeout(updateProgressCircles, 2000);
                return;
            }

            let iframeDocument = iframe.contentWindow.document;
            let progressCircles = iframeDocument.querySelectorAll("circle.progress-circle__runner");

            if (!progressCircles.length) {
                console.warn("âš ï¸ No progress circles found inside SCORM iframe. Retrying...");
                setTimeout(updateProgressCircles, 2000);
                return;
            }

            console.log("âœ… Found Progress Circles:", progressCircles);

            let miniLessonProgress = JSON.parse('{{ mini_lesson_progress|safe }}'.replace(/'/g, '"'));
            console.log("ðŸ“Š Extracted Lesson Progress Data:", miniLessonProgress);

            miniLessonProgress.forEach((miniLesson, index) => {
                let { mini_lesson_index, progress } = miniLesson;

                if (mini_lesson_index >= progressCircles.length) {
                    console.warn(`âš ï¸ No matching progress circle for mini-lesson ${mini_lesson_index}`);
                    return;
                }

                let circle = progressCircles[mini_lesson_index];

                // Extract progress percentage (e.g., "23% Completed" â†’ 23)
                let progressPercentage = parseFloat(progress.replace("% Completed", "").trim()) || 0;

                // **Update stroke-dashoffset based on progress**
                let totalStroke = 43.982297150257104; // Outer circle full stroke
                let strokeOffset = totalStroke * (1 - (progressPercentage / 100));

                console.log(`ðŸ”„ Setting progress circle ${mini_lesson_index} to ${progressPercentage}% (Offset: ${strokeOffset})`);

                // Apply stroke offset
                circle.setAttribute("stroke-dashoffset", strokeOffset);
                circle.style.transition = "stroke-dashoffset 0.5s ease-in-out";

                // Force reapply after SCORM loads
                setTimeout(() => {
                    circle.setAttribute("stroke-dashoffset", strokeOffset);
                }, 1000);
            });

            console.log("ðŸŽ¯ Progress circles updated successfully.");
        }

        // Ensure the SCORM iframe is fully loaded before running
        waitForSCORMIframe(updateProgressCircles);

        function showSCORMCheckmarks(iframe) {
            let iframeDocument = iframe.contentWindow.document;
            let checkmarks = iframeDocument.querySelectorAll("path.progress-circle__pass");

            if (checkmarks.length === 0) {
                console.warn("âš ï¸ No checkmarks found. Make sure SCORM has loaded.");
                return;
            }

            checkmarks.forEach((checkmark) => {
                //console.log("âœ… Making checkmark visible:", checkmark);

                checkmark.style.display = "block";
                checkmark.style.opacity = "1";
                checkmark.style.visibility = "visible";

                // Ensure it's not hidden by SCORM's CSS
                let parentSVG = checkmark.closest("svg.progress-circle--sidebar");
                if (parentSVG) {
                    parentSVG.style.display = "block";
                    parentSVG.style.opacity = "1";
                    parentSVG.style.visibility = "visible";
                }
            });

            console.log("âœ… All checkmarks should now be visible.");
        }

        function observeSCORMCheckmarks(iframe) {
            let iframeDocument = iframe.contentWindow.document;
            let observer = new MutationObserver(() => {
                console.log("ðŸ”„ SCORM UI updated, ensuring checkmarks remain visible...");
                showSCORMCheckmarks(iframe);
            });

            observer.observe(iframeDocument.body, {
                childList: true,
                subtree: true
            });
        }

        waitForSCORMIframe((iframe) => {
            showSCORMCheckmarks(iframe);
            observeSCORMCheckmarks(iframe);
        });

        function trackMiniLessonProgress() {
            console.log("ðŸ” Checking mini-lesson progress...");

            let lessonProgressArray = [];
            const iframe = document.getElementById("scormContentIframe");

            if (iframe && iframe.contentWindow) {
                const progressElements = iframe.contentWindow.document.querySelectorAll('[aria-label*="Completed"], [aria-label*="% Completed"]');

                progressElements.forEach((el, index) => {
                    const progressText = el.getAttribute("aria-label") || "Unknown";
                    const miniLessonId = el.getAttribute("data-lesson-id") || window.lessonId; 
                    const miniLessonIndex = index;

                    lessonProgressArray.push({
                        lesson_id: miniLessonId,  // âœ… Sending unique mini-lesson ID
                        mini_lesson_index: index,
                        user_id: window.userId,
                        progress: progressText
                    });
                });

                console.log("ðŸ“Š Extracted Lesson Progress Data:", lessonProgressArray);

                if (lessonProgressArray.length > 0) {
                    console.log("ðŸ” BEFOOOOOOOOOOOOOOOOOOOOOOREEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE..");
                    sendMiniLessonProgress(lessonProgressArray);  // âœ… Send to backend
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("Adding progress tracking interval.");
            setInterval(trackProgress, 30000);  // Track progress and scroll position every 30 seconds
            setInterval(trackMiniLessonProgress, 30000);
        });

        document.addEventListener("DOMContentLoaded", function () {
            let savedProgressString = '{{ mini_lessons_progress|escapejs }}';
            let savedProgress;

            try {
                savedProgress = savedProgressString && savedProgressString !== 'null' ? JSON.parse(savedProgressString) : [];
            } catch (error) {
                console.error("JSON parsing error for mini_lessons_progress:", error);
                savedProgress = []; // Default to empty array to prevent crash
            }

            console.log("Saved Progress Data:", savedProgress);


            function applySavedProgress() {
                const iframe = document.getElementById("scormContentIframe");
                if (iframe && iframe.contentWindow) {
                    const iframeDocument = iframe.contentWindow.document;
                    const progressElements = iframeDocument.querySelectorAll('[aria-label*="Completed"], [aria-label*="% Completed"]');

                    progressElements.forEach((el, index) => {
                        const progress = savedProgress[index];
                        if (progress) {
                            el.setAttribute("aria-label", progress);
                            if (progress.includes("Completed")) {
                                el.classList.add("completed"); // Add a class if completed
                            } else {
                                const progressBar = el.querySelector(".progress-bar");
                                if (progressBar) {
                                    const percentage = parseInt(progress);
                                    progressBar.style.width = `${percentage}%`;
                                }
                            }
                        }
                    });
                } else {
                    console.warn("Iframe not ready, retrying...");
                    setTimeout(applySavedProgress, 1000); // Retry if iframe isn't loaded
                }
            }

            // Apply saved progress after the iframe is loaded
            const iframe = document.getElementById("scormContentIframe");
            iframe.addEventListener("load", applySavedProgress);
        });

        //function updateProgress(currentPage) {
            // Add current page to visited set
            //pagesVisited.add(currentPage);

            //if (totalPages > 0) {
                //const progress = pagesVisited.size / totalPages;
                //window.API_1484_11.SetValue("cmi.progress_measure", progress.toFixed(2));
                //console.log(`Progress Updated: ${progress}`);
                //trackProgress();
            //}
        //}

        function getProgressFromIframe() {
            const iframe = document.getElementById("scormContentIframe");
            console.log("Checking iframe for progress...");

            if (iframe && iframe.contentWindow) {
                try {
                    const iframeDocument = iframe.contentWindow.document;

                    // Select the element containing the progress text
                    const progressElement = iframeDocument.querySelector(".nav-sidebar-header__progress-text");
                    if (progressElement) {
                        const progressText = progressElement.textContent.trim();
                        console.log("Progress Element Text Found:", progressText);

                        // Extract numeric value from progress text (e.g., "10% COMPLETE")
                        const progressMatch = progressText.match(/(\d+)%/);
                        if (progressMatch) {
                            const progressValue = parseInt(progressMatch[1], 10);
                            console.log("Extracted Progress Value:", progressValue);

                            return progressValue / 100; // Convert to decimal (e.g., 0.1)
                        }
                    } else {
                        console.warn("No progress element found matching the selector.");
                    }
                } catch (error) {
                    console.error("Error accessing iframe content for progress:", error);
                }
            } else {
                console.error("Iframe or iframe.contentWindow not available.");
            }
            return 0; // Default progress if not found
        }


        function updateSidebarProgress() {
            console.log("Updating sidebar progress on page load...");

            let attemptCount = 0;
            function tryUpdateProgress() {
                let savedProgress = window.savedProgress;
                const progressPercentage = Math.round(savedProgress * 100); // Convert decimal to percentage

                // Get the progress bar elements inside the iframe
                const iframe = document.getElementById("scormContentIframe");
                if (iframe && iframe.contentWindow) {
                    try {
                        const iframeDocument = iframe.contentWindow.document;
                        
                        // Select the progress text and progress bar elements
                        const progressTextElement = iframeDocument.querySelector(".nav-sidebar-header__progress-text");
                        const progressBarElement = iframeDocument.querySelector(".nav-sidebar-header__progress-runner"); // Adjusted selector
                        
                        if (progressTextElement) {
                            progressTextElement.textContent = `${progressPercentage}% COMPLETE`;
                            console.log(`âœ… Updated sidebar progress text to ${progressPercentage}%`);
                        }

                        if (progressBarElement) {
                            progressBarElement.style.width = `${progressPercentage}%`;
                            progressBarElement.style.transition = "width 0.5s ease-in-out"; // Smooth transition effect
                            console.log(`âœ… Updated sidebar progress bar width to ${progressPercentage}%`);
                        } else if (attemptCount < 10) {
                            attemptCount++;
                            console.warn(`âš ï¸ Progress bar not found, retrying... (${attemptCount})`);
                            setTimeout(tryUpdateProgress, 500); // Retry after 500ms
                        } else {
                            console.error("ðŸš¨ Failed to update progress bar after multiple attempts.");
                        }
                        // âœ… New Logic: Apply mini-lesson progress updates
                        //applyMiniLessonProgress(progressData);

                    } catch (error) {
                        console.error("âš ï¸ Error accessing iframe content for progress update:", error);
                    }
                } else {
                    console.warn("âš ï¸ Iframe not fully loaded, retrying...");
                    setTimeout(tryUpdateProgress, 500);
                }
            }

            // Start the retry mechanism
            setTimeout(tryUpdateProgress, 500);
        }

        // Run this function when the SCORM iframe loads
        document.addEventListener("DOMContentLoaded", function () {
            const iframe = document.getElementById("scormContentIframe");

            iframe.addEventListener("load", function () {
                console.log("âœ… SCORM content loaded, updating progress bar...");
                updateSidebarProgress();
            });
        });

        function getMiniLessonProgress(scoIndex) {
            if (window.API_1484_11) {
                let progress = window.API_1484_11.GetValue(`cmi.objectives.${scoIndex}.progress_measure`);
                let completionStatus = window.API_1484_11.GetValue(`cmi.objectives.${scoIndex}.completion_status`);
                
                console.log(`ðŸ“Š Mini-Lesson ${scoIndex}: Progress = ${progress}, Status = ${completionStatus}`);
                
                return {
                    progress: progress ? parseFloat(progress) : 0,
                    status: completionStatus || "unknown"
                };
            }
            return null;
        }

        // Set progress tracking interval
        //document.addEventListener("DOMContentLoaded", function () {
            //console.log("Adding progress tracking interval.");
            //setInterval(trackProgress, 30000); // Track progress every 60 seconds
        //});
        /*
        function applyMiniLessonProgress(progressData) {
            console.log("ðŸŽ¯ Applying Mini-Lesson Progress:", progressData);

            // Select all sidebar progress indicators
            const sidebarItems = document.querySelectorAll('.lesson-progress_graphic .progress-circle--sidebar');

            if (!sidebarItems.length) {
                console.warn("âš ï¸ No sidebar progress circles found. Retrying...");
                setTimeout(() => applyMiniLessonProgress(progressData), 1000); // Retry if not found
                return;
            }

            progressData.forEach((item) => {
                let { mini_lesson_index, progress } = item;
                console.log(`ðŸ” Lesson Index: ${mini_lesson_index}, Progress: ${progress}`);

                const sidebarItem = sidebarItems[mini_lesson_index];  // Select the corresponding progress circle

                if (sidebarItem) {
                    console.log(`âœ… Found sidebar item for index ${mini_lesson_index}. Updating...`);

                    // Update aria-label
                    sidebarItem.setAttribute("aria-label", `${progress}`);

                    // Find progress circle runner
                    const progressCircle = sidebarItem.querySelector('.progress-circle_runner');

                    if (progressCircle) {
                        let progressValue = progress.includes("Completed") ? 100 : parseInt(progress) || 0;
                        let radius = 7;
                        let circumference = 2 * Math.PI * radius;
                        let offset = circumference * (1 - progressValue / 100);

                        progressCircle.style.strokeDasharray = `${circumference}`;
                        progressCircle.style.strokeDashoffset = `${offset}`;
                        console.log(`âœ… Updated progress circle for index ${mini_lesson_index}: ${progressValue}%`);
                    } else {
                        console.warn(`âš ï¸ No progress-circle_runner found for index: ${mini_lesson_index}`);
                    }
                } else {
                    console.warn(`âš ï¸ Sidebar item not found for mini-lesson index: ${mini_lesson_index}`);
                }
            });
        }
        */
        // Call function after page fully loads
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                console.log("ðŸš€ Applying Mini-Lesson Progress...");
                //applyMiniLessonProgress(window.miniLessonProgress || []);
            }, 2000);
        });
        /*
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Checking for saved progress...");

            const iframe = document.getElementById("scormContentIframe");

            window.savedLocation = "{{ saved_location|escapejs }}";
            window.savedScrollPosition = parseInt("{{ saved_scroll_position|escapejs }}", 10) || 0;

            if (window.savedLocation) {
                console.log(`Resuming at saved location: ${window.savedLocation}`);

                iframe.addEventListener("load", function () {
                    console.log(`Navigating to saved location: ${window.savedLocation}`);
                    iframe.contentWindow.location.href = window.savedLocation;

                    console.log("SCORM content loaded. Applying mini-lesson progress.");
                    //applyMiniLessonProgress(progressData);  // Apply saved progress when iframe loads

                    setTimeout(() => {
                        try {
                            console.log(`Restoring scroll position to: ${window.savedScrollPosition}`);
                            iframe.contentWindow.scrollTo(0, window.savedScrollPosition);
                        } catch (error) {
                            console.error("Error restoring scroll position:", error);
                        }
                    }, 2000); // âœ… Delay to ensure content fully loads
                });
            }

            function getScrollPosition() {
                try {
                    let iframeDocument = iframe.contentWindow.document;
                    let scrollPosition = iframeDocument.scrollingElement.scrollTop || 
                                        iframeDocument.documentElement.scrollTop || 
                                        iframeDocument.body.scrollTop || 0;

                    console.log(`ðŸ“Œ Captured Scroll Position: ${scrollPosition}`);
                    return scrollPosition;
                } catch (error) {
                    console.error("ðŸš¨ Error reading scroll position:", error);
                    return 0;
                }
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            console.log("Adding progress tracking interval.");
            setInterval(trackProgress, 30000); // Track progress every 30 seconds
            console.log("SCORM content loaded. Applying mini-lesson progress.");
            //applyMiniLessonProgress(progressData);  // Apply saved progress when iframe loads
            //console.log("HEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE")

            if (iframe) {
                // Add the load event listener to track progress once iframe loads content
                iframe.addEventListener("load", function () {
                    const progress = getProgressFromIframe();
                    console.log(`Current Progress: ${progress * 100}%`);
                });

                // Log available iframe content (optional for debugging)
                if (iframe.contentWindow) {
                    console.log("iframe contentWindow properties:", Object.keys(iframe.contentWindow));
                }

                // Load event to handle specific SCORM interactions or content
                iframe.addEventListener("load", () => {
                    console.log("SCORM content iframe loaded");

                    try {
                        // Example of LMSProxy override (already in your script)
                        const iframeWindow = iframe.contentWindow;

                        if (iframeWindow && iframeWindow.LMSProxy) {
                            console.log("LMSProxy detected. Wrapping SetDataChunk...");

                            const originalSetDataChunk = iframeWindow.LMSProxy.SetDataChunk;

                            iframeWindow.LMSProxy.SetDataChunk = function (data) {
                                console.log("SetDataChunk called with data:", data);

                                // Process SetDataChunk data and extract progress (your existing logic)
                                if (data) {
                                    try {
                                        const parsedData = JSON.parse(data);
                                        console.log("Parsed SetDataChunk data:", parsedData);

                                        if (parsedData.totalSlides) {
                                            totalPages = parsedData.totalSlides;
                                            console.log("Total Slides Updated:", totalPages);
                                        }

                                        if (parsedData.currentSlide) {
                                            const currentPage = parsedData.currentSlide;
                                            pagesVisited.add(currentPage);
                                            console.log("Current Slide Visited:", currentPage);

                                            if (totalPages > 0) {
                                                const progress = pagesVisited.size / totalPages;
                                                window.API_1484_11.SetValue("cmi.progress_measure", progress.toFixed(2));
                                                console.log(`Progress Updated: ${progress}`);
                                            }
                                        }
                                    } catch (error) {
                                        console.error("Error parsing SetDataChunk data:", error);
                                    }
                                }

                                return originalSetDataChunk.apply(this, arguments);
                            };
                        } else {
                            console.warn("LMSProxy not found in iframe content.");
                        }
                    } catch (error) {
                        console.error("Error wrapping LMSProxy.SetDataChunk:", error);
                    }
                });
            } else {
                console.error("Iframe with ID 'scormContentIframe' not found.");
            }
        });
        */
        document.addEventListener("DOMContentLoaded", function () {
            console.log("ðŸ“Œ Initializing SCORM progress and screen tracking...");

            const iframe = document.getElementById("scormContentIframe");

            window.savedLocation = "{{ saved_location|escapejs }}";
            window.savedScrollPosition = parseInt("{{ saved_scroll_position|escapejs }}", 10) || 0;
            let lessonScrollPositions = JSON.parse(localStorage.getItem("lessonScrollPositions") || "{}");

            if (window.savedLocation) {
                console.log(`Resuming at saved location: ${window.savedLocation}`);

                iframe.addEventListener("load", function () {
                    console.log(`Navigating to saved location: ${window.savedLocation}`);
                    iframe.contentWindow.location.href = window.savedLocation;

                    console.log("SCORM content loaded. Applying mini-lesson progress.");
                    setTimeout(() => {
                        try {
                            console.log(`Restoring scroll position to: ${window.savedScrollPosition}`);
                            iframe.contentWindow.scrollTo(0, window.savedScrollPosition);
                        } catch (error) {
                            console.error("Error restoring scroll position:", error);
                        }
                    }, 2000); // âœ… Delay to ensure SCORM content fully loads
                });
            }

            function getActiveLessonId() {
                let activeLessonElement = document.querySelector(".lesson-item.active, .lesson-item.current");
                console.log('LESSSSSSSSSSSSSSSON: ', activeLessonElement)
                return activeLessonElement ? activeLessonElement.getAttribute("data-lesson-id") : null;
            }
            /*
            function getScrollPosition() {
                try {
                    let iframeDocument = iframe.contentWindow.document;
                    let scrollContainer = iframeDocument.querySelector(".scorm-content") || iframeDocument.body;
                    let scrollPosition = scrollContainer.scrollTop;

                    console.log(`ðŸ“Œ Captured Scroll Position: ${scrollPosition}`);
                    return scrollPosition;
                } catch (error) {
                    console.error("ðŸš¨ Error reading scroll position:", error);
                    return 0;
                }
            }
            */
            function getLessonLocation() {
                try {
                    let lessonLocation = iframe.contentWindow.location.href;
                    console.log(`ðŸ“ Captured Lesson Location: ${lessonLocation}`);
                    return lessonLocation;
                } catch (error) {
                    console.error("ðŸš¨ Error retrieving lesson location:", error);
                    return "";
                }
            }
            
            function saveLessonProgress() {
                let lessonId = window.lessonId;
                if (!lessonId) {
                    console.warn("âš ï¸ No active lesson found, skipping progress save.");
                    return;
                }

                try {
                    let iframe = document.getElementById("scormContentIframe");
                    let scrollPosition = 0;

                    if (iframe && iframe.contentWindow) {
                        scrollPosition = iframe.contentWindow.scrollY || 
                                        iframe.contentWindow.document.documentElement.scrollTop || 
                                        iframe.contentWindow.document.body.scrollTop || 0;
                    }

                    let lessonLocation = getLessonLocation();

                    lessonScrollPositions[lessonId] = { scrollPosition, lessonLocation };
                    localStorage.setItem("lessonScrollPositions", JSON.stringify(lessonScrollPositions));

                    console.log(`âœ… Progress Saved for Lesson ${lessonId}:`, lessonScrollPositions[lessonId]);

                    sendTrackingData({
                        lesson_id: lessonId,
                        user_id: window.userId,
                        progress: getProgressFromIframe(),
                        lesson_location: lessonLocation, // ðŸ”¹ Send the exact lesson location
                        scroll_position: scrollPosition, // ðŸ”¹ Send the exact scroll position
                        completion_status: "incomplete",
                        session_time: getSessionTime(),
                        score: null,
                    });

                } catch (error) {
                    console.error("ðŸš¨ Error saving lesson progress:", error);
                }
            }

            function restoreLessonProgress() {
                let lessonId = window.lessonId;
                console.log('LESSSSSSSSSSSSSSSSSSSSSONNNNNNNNNNNNNNNNNNNNNNNN: ', lessonId)
                if (!lessonId || !lessonScrollPositions[lessonId]) {
                    console.warn("âš ï¸ No saved progress for this lesson.");
                    return;
                }

                iframe.addEventListener("load", function () {
                    setTimeout(() => {
                        try {
                            let savedData = lessonScrollPositions[lessonId];
                            let savedScrollPosition = savedData.scrollPosition || 0;
                            let savedLessonLocation = savedData.lessonLocation || "";

                            console.log(`ðŸ”„ Restoring Lesson Progress for ${lessonId}:`, savedData);

                            let currentLessonLocation = iframe.contentWindow.location.href;
                            
                            if (currentLessonLocation !== savedLessonLocation) {
                                console.warn("âš ï¸ SCORM changed the lesson location. Resetting...");
                                iframe.contentWindow.location.href = savedLessonLocation;
                            }

                            let iframeDocument = iframe.contentWindow.document;
                            let scrollContainer = iframeDocument.querySelector(".scorm-content") || iframeDocument.body;
                            scrollContainer.scrollTo(0, savedScrollPosition);

                        } catch (error) {
                            console.error("ðŸš¨ Error restoring lesson progress:", error);
                        }
                    }, 2500); // âœ… Delay to allow SCORM to fully load before restoring location
                });
            }

            function sendTrackingData(trackingData) {
                console.log("ðŸ“¡ Sending SCORM tracking data to backend...", trackingData);

                fetch('/course_player/track-scorm-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(trackingData),
                })
                .then(response => response.json())
                .then(data => {
                    console.log("âœ… SCORM progress successfully updated:", data);
                    console.log("TACKING: ", trackingData)
                })
                .catch(error => console.error("ðŸš¨ Error sending SCORM tracking data:", error));
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function getProgressFromIframe() {
                let iframeDocument = iframe.contentWindow.document;
                let progressElement = iframeDocument.querySelector(".nav-sidebar-header__progress-text");

                if (progressElement) {
                    let progressText = progressElement.textContent.trim();
                    console.log("ðŸ“Š Found Progress Text:", progressText);

                    let progressMatch = progressText.match(/(\d+)%/);
                    if (progressMatch) {
                        let progressValue = parseInt(progressMatch[1], 10);
                        console.log("ðŸ“ Extracted Progress Value:", progressValue);
                        return progressValue / 100;
                    }
                }
                console.warn("âš ï¸ No progress element found.");
                return 0;
            }

            function getSessionTime() {
                const now = new Date();
                const duration = Math.floor((now - sessionStartTime) / 1000);

                const hours = Math.floor(duration / 3600);
                const minutes = Math.floor((duration % 3600) / 60);
                const seconds = duration % 60;

                return `PT${hours}H${minutes}M${seconds}S`;
            }

            // Save scroll position on scroll
            iframe.addEventListener("scroll", function () {
                saveLessonProgress();
            });

            // Restore scroll position when SCORM loads
            iframe.addEventListener("load", function () {
                console.log("âœ… SCORM iframe loaded, restoring lesson progress...");
                restoreScrollPosition();
                restoreLessonProgress();
            });

            // Ensure scroll position is saved every 30 seconds
            setInterval(saveLessonProgress, 30000);
        });
    </script>
    
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- SCORM Content Area -->
            <div class="col-md-9 p-3">
                <iframe 
                    id="scormContentIframe"
                    src="{{ scorm_index_file_url }}"
                    frameborder="0"
                    width="100%"
                    height="800px"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-top-navigation allow-downloads"
                    allowfullscreen>
                </iframe>
            </div>
    
             <!-- Right Sidebar -->
             <div class="col-md-3 right-sidebar">

                {% if prev_lesson %}
                    <button id="prevLessonBtn" class="btn btn-secondary w-100 mb-3" 
                            onclick="launchPrevLesson({{ prev_lesson.id }})">
                        Previous Lesson
                    </button>
                {% endif %}

                {% if next_lesson %}
                <button id="nextLessonBtn" class="btn btn-primary w-100 mb-3" 
                        onclick="launchNextLesson({{ next_lesson.id }})"
                        disabled>
                    Next Lesson
                </button>        
                {% else %}
                    <button id="finishCourseBtn" class="btn btn-success w-100 mb-3" 
                            onclick="finishCourse()" style="display: none;">
                        Finish Course
                    </button>
                {% endif %}

                <div class="sidebar-header">Course Progress</div>

                <div class="progress-bar-container">
                    <div class="progress-bar" id="courseProgressBar" style="width: 0%;"></div>
                </div>
                <span id="courseProgressText">{{ user_course.progress }}%</span>
                {{ lesson_progress_data|json_script:"lessonData" }}
                <div id="lessonList">
                    {% for lesson in all_lessons %}
                        <div class="lesson-item" data-lesson-id="{{ lesson.id }}">
                            {{ lesson.title }}
                        </div>
                    {% endfor %}
                </div>                                                                                           
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const parsedLessonData = JSON.parse(document.getElementById('lessonData').textContent);
            console.log("Loading lesson data into sidebar...", parsedLessonData);

            document.querySelectorAll('.lesson-item').forEach(item => {
                let lessonId = item.getAttribute("data-lesson-id");
                console.log('lessonId:', lessonId, 'item:', item);
                if (lessonId) {
                    item.addEventListener('click', function() {
                        console.log("ðŸš€ Launching Lesson ID:", lessonId);
                        window.location.href = `/launch_scorm_file/${lessonId}/`;
                    });
                } else {
                    console.warn("âš ï¸ Missing Lesson ID for:", item.innerText);
                }
            });

            console.log("Checking if all lessons are completed...");

            let allLessonsCompleted = true;
            
            document.querySelectorAll('.lesson-item').forEach(item => {
                let isCompleted = item.classList.contains("lesson-completed"); // Checks if lesson has "completed" class
                if (!isCompleted) {
                    allLessonsCompleted = false;
                }
            });

            if (allLessonsCompleted) {
                console.log("âœ… All lessons completed! Showing 'Finish Course' button.");
                document.getElementById("finishCourseBtn").style.display = "block"; // Show button
            } else {
                console.log("âŒ Not all lessons are completed yet.");
            }

            console.log("Checking if the current lesson is completed...");

            let currentLessonId = window.lessonId;
            let currentLesson = window.lessonData.find(lesson => lesson.id == currentLessonId);

            if (currentLesson && currentLesson.completed) {
                console.log("âœ… Current lesson is completed. Enabling 'Next Lesson' button.");
                document.getElementById("nextLessonBtn").removeAttribute("disabled"); // Enable button
            } else {
                console.log("âŒ Current lesson is NOT completed. Next lesson is locked.");
            }
        });

        function launchNextLesson(lessonId) {
            if (lessonId) {
                window.location.href = `/launch_scorm_file/${lessonId}/`;
            }
        }

        function launchPrevLesson(lessonId) {
            if (lessonId) {
                window.location.href = `/launch_scorm_file/${lessonId}/`;
            }
        }

        function finishCourse() {
            window.location.href = "/courses/";  // Redirects user back to dashboard
        }

        function launchLesson(lessonId) {
            console.log("ðŸš€ Launching lesson with ID:", lessonId);
            if (lessonId) {
                window.location.href = `/launch_scorm_file/${lessonId}/`;
            } else {
                console.error("âŒ Lesson ID is missing.");
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("Loading user course progress...");

            // Retrieve user course progress (use default 0 if None)
            let userCourseProgress = {{ user_course.progress|default:0 }};

            // Update progress bar and text
            let progressBar = document.getElementById("courseProgressBar");
            let progressText = document.getElementById("courseProgressText");

            if (progressBar && progressText) {
                progressBar.style.width = `${userCourseProgress}%`;
                progressText.textContent = `${userCourseProgress}%`;
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const iframe = document.getElementById("scormContentIframe");

            if (iframe) {
                iframe.addEventListener("load", function () {
                    console.log("ðŸ“Œ Triggering scroll restoration...");
                    restoreScrollPosition();
                });
            } else {
                console.warn("âŒ SCORM iframe not found.");
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.lesson-item').forEach(item => {
                if (!item.classList.contains("locked")) {
                    let lessonId = item.getAttribute("data-lesson-id");
                    item.addEventListener('click', function() {
                        window.location.href = `/launch_scorm_file/${lessonId}/`;
                    });
                }
            });
        });

    </script>    
</body>
</html>