{% load static %}
{% load custom_filters %}
<!-- Sidebar area -->
<div id="courseSidebar" class="course-sidebar-container">
    <div class="course-sidebar-header">
        <div class="course-sidebar-header-top">
            <h4>Course Progress</h4>
            <span id="courseProgressText">{{ user_course.progress|default:0 }}%</span>
        </div>
        <div class="course-sidebar-header-bottom">
            <div class="course-item-progress-bar-container">
                <div id="courseProgressBar" class="course-item-progress-bar" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    <div class="course-sidebar-body scrollable-content">
        {{ lesson_progress_data|json_script:"lessonData" }}

        <div id="lessonList">
            <!-- {% for module in modules_with_lessons %}
                <div class="module-section-container">
                    <div class="module-title">
                        <span>{{ module.title }}</span>
                    </div>
                    <div class="lesson-section-container">
                        {% for lesson in module.lessons.all %}
                            <button class="lesson-item" data-lesson-id="{{ lesson.id }}" onclick="launchLessonById({{ lesson.id }})">
                                <div class="lesson-item-left">
                                    <div class="lesson-item-number">
                                        <span>{{ forloop.counter }}</span>
                                    </div>
                                    <div class="lesson-item-text">
                                        <span>{{ lesson.title }}</span>
                                    </div>
                                </div>
                                <div class="lesson-item-right"></div>
                                
                            </button>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %} -->
            {% for module in modules_with_lessons %}
                <div class="details-info-card">
                    <div class="module-card-header collapsable-header">
                        <div class="card-header-left">
                            <div class="module-title" title="{{ module.title }}">
                                <span>{{ forloop.counter }}. {{ module.title }}</span>
                            </div>
                        </div>
                        <div class="lesson-completion-counter" data-module-id="{{ module.id }}">
                            <span>0/0</span>
                        </div>
                        <div class="card-header-right active">
                            <i class="fa-regular fa-angle-down"></i>
                        </div>
                    </div>
                    <div class="info-card-body hidden">                         
                        <div class="module-lessons-section">
                            {% for lesson in module.lessons.all %}
                                <button class="lesson-item" data-lesson-id="{{ lesson.id }}" onclick="launchLessonById({{ lesson.id }})">
                                    <div class="lesson-item-left">
                                        <div class="lesson-item-number">
                                            <span>{{ forloop.counter }}</span>
                                        </div>
                                        <div class="lesson-item-text" title="{{ lesson.title }}">
                                            <span>{{ lesson.title }}</span>
                                        </div>
                                    </div>
                                    <div class="lesson-item-right"></div>
                                    
                                </button>
                            {% endfor %}
                        </div>                 
                    </div>
                </div>
            {% endfor %}
        </div>
        
    </div>
    <!-- <div class="course-sidebar-footer">
        
    </div>   -->
</div>
<script>
    // window.progressDataString = '{{ lesson_progress_data|default:"[]"|escapejs }}';
    window.lessonId = {{ lesson.id|default:"0" }};
    window.userId = {{ profile_id|default:"0" }};
    window.courseLocked = {{ course_locked|yesno:"true,false" }};
    window.miniLessonProgress = {{ mini_lesson_progress|default:"[]"|safe }};
    window.lessonContentType = "{{ lesson.content_type }}";
    window.lessonLocation = "{{ lesson.lesson_location }}";
    window.savedProgress = {{ saved_progress|default:0 }};
    window.lessonSessionId = "{{ request.session.current_lesson_session_id }}";
    window.nextlessonId = "{{ next_lesson.id }}";

    const launchScormUrlTemplate = "{% url 'launch_scorm_file' 0 %}".replace("/0/", "/");

    function launchLessonById(lessonId) {
        window.location.href = launchScormUrlTemplate + lessonId + "/";
    }

    function launchNextLesson(nextLessonId) {
        launchLessonById(nextLessonId);
    }

    function launchPrevLesson(prevLessonId) {
        launchLessonById(prevLessonId);
    }

    document.addEventListener("DOMContentLoaded", function () {
        try {
            const rawData = `{{ lesson_progress_data|escapejs }}`;
            const parsedData = JSON.parse(rawData);
            window.lessonData = parsedData;
            console.log('ðŸ§ª parsedData:', parsedData);

            const urlPath = window.location.pathname;
            const match = urlPath.match(/\/launch_scorm_file\/(\d+)\//);
            const currentLessonIdFromUrl = match ? parseInt(match[1]) : null;

            document.querySelectorAll('.lesson-item').forEach(item => {
                const id = parseInt(item.dataset.lessonId);
                const lesson = parsedData.find(l => l.id === id);
                const lessonRight = item.querySelector('.lesson-item-right');
                const lessonProgress = item.querySelector('.lesson-progress');
                if (!lesson) return;

                const isCurrentLesson = id === currentLessonIdFromUrl;
                const isLocked = window.courseLocked && lesson.locked;
                const currentLessonIndex = parsedData.findIndex(l => l.id === currentLessonIdFromUrl);
                const nextLesson = parsedData[currentLessonIndex + 1];

                // Locking the Next Lesson Btn if the next lesson is locked
                if (nextLesson && (nextLesson.locked || (window.courseLocked && nextLesson.locked))) {
                    const nextBtn = document.getElementById('nextLessonBtn');
                    if (nextBtn) {
                        nextBtn.classList.add('disabled');
                        nextBtn.setAttribute('disabled', true);
                    }
                } else {
                    console.log("âœ… Next lesson is unlocked or doesn't exist.");
                }
                
                item.setAttribute('data-lesson-progress', lesson.progress);

                if (lesson.completed) {
                    item.classList.add("lesson-completed");

                    const checkmark = document.createElement("div");
                    checkmark.classList.add('lesson-complete-icon');
                    checkmark.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                    if (lessonRight) lessonRight.appendChild(checkmark);
                    return;
                }

                if (lesson.progress != null && !isLocked) {
                    const progressText = document.createElement('span');
                    progressText.className = 'lesson-progress';
                    progressText.textContent = `${lesson.progress}%`;
                    if (lessonRight) lessonRight.appendChild(progressText);
                }

                if (isLocked && !isCurrentLesson && !lesson.completed) {
                    const lockedIcon = document.createElement('div');
                    lockedIcon.classList.add('lesson-locked-icon');
                    lockedIcon.innerHTML = '<i class="fas fa-lock"></i>';
                    if (lessonRight) lessonRight.appendChild(lockedIcon);
                    item.classList.add('locked');
                    item.classList.add('disabled');
                    item.setAttribute('disabled', true);
                } else {
                    console.log("ðŸ”“ Current lesson remains unlocked:", id);
                }
            });

            document.querySelectorAll('.details-info-card').forEach(moduleCard => {
                const lessonButtons = moduleCard.querySelectorAll('.lesson-item');
                const counterEl = moduleCard.querySelector('.lesson-completion-counter span');

                let total = 0;
                let completed = 0;

                lessonButtons.forEach(button => {
                    const id = parseInt(button.dataset.lessonId);
                    const lesson = window.lessonData.find(l => l.id === id);
                    if (!lesson) return;

                    total++;
                    if (lesson.completed) completed++;
                });

                if (counterEl) {
                    counterEl.textContent = `${completed}/${total}`;
                }
            });

        } catch (e) {
            console.warn("âŒ Failed to update sidebar lesson progress:", e);
        }             

        const iframe = document.getElementById("scormContentIframe");
        const fallbackScormUrl = "{{ scorm_index_file_url|escapejs }}";
        const intendedUrl = "{{ lesson_location|escapejs }}" || fallbackScormUrl;
    
        // âœ… Force iframe to exact saved lesson location on load
        if ("{{ lesson.content_type }}" === "SCORM2004" && iframe) {
            const urlToLoad = intendedUrl !== "about:blank" ? intendedUrl : fallbackScormUrl;
            console.log("â© Forcing SCORM iframe to load:", urlToLoad);
            iframe.src = urlToLoad;
        }

        // âœ… Highlight current lesson
        const currentLessonId = parseInt(window.lessonId, 10);
        document.querySelectorAll('.lesson-item').forEach(item => {
            item.classList.remove('active-lesson');
        });
        const activeLessons = document.querySelectorAll(`.lesson-item[data-lesson-id="${currentLessonId}"]`);

        activeLessons.forEach(activeLesson => {
            activeLesson.classList.add('active-lesson');

            const parentCard = activeLesson.closest('.details-info-card');
            if (!parentCard) return;

            const cardBody = parentCard.querySelector('.info-card-body');
            if (cardBody) {
                cardBody.classList.toggle('hidden'); // assumes 'hidden' = display: none
            }

            const cardHeaderRight = parentCard.querySelector('.card-header-right');
            if (cardHeaderRight) {
                cardHeaderRight.classList.toggle('active');
            }

            const cardHeader = parentCard.querySelector('.collapsable-header');
            if (cardHeader) {
                cardHeader.classList.toggle('active');
            }
        });

        // âœ… Set course progress bar
        const courseProgressBar = document.getElementById("courseProgressBar");
        const courseProgressText = document.getElementById("courseProgressText");
        if (courseProgressBar && courseProgressText) {
            const percentMatch = courseProgressText.textContent.match(/(\d+)%/);
            if (percentMatch) {
                const progress = parseInt(percentMatch[1], 10);
                courseProgressBar.style.width = `${progress}%`;
            }
        }

        // âœ… Show "Finish Course" button
        // const finishBtn = document.getElementById("finishCourseBtn");
        // if (finishBtn) {
        //     finishBtn.style.display = "block";
        // }
    });
</script>