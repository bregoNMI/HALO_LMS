{% extends 'base.html' %}
{% load static %}
{% block content %}
    {% include 'messageContainer/message_container.html' %}
    <div id="stickyNavBar">
        <div class="details-top-row max-width-extend-1">
            <div class="details-top-row-left">
                <button type="button" onclick="handleBackButton()" class="back-btn dynamic-back-btn">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h3> Edit Quiz Template </h3>
            </div>
            <div class="details-top-row-right">
                <div class="option-btn-row">
                    <button class="action-button-primary edit-template-btn course-save-btns" data-template-id="{{ quiz_template.id }}">
                        <i class="fa-regular fa-floppy-disk"></i>
                        <span>Save Changes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="admin-body align-center">
        <div class="max-width-extend-1">
            <div id="mainNavBar" class="details-top-row">
                <div class="details-top-row-left">
                    <button type="button" onclick="handleBackButton()" class="back-btn dynamic-back-btn">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <h3> Edit Quiz Template </h3>
                </div>
                <div class="details-top-row-right">
                    <div class="option-btn-row">
                        <button class="action-button-primary course-save-btns edit-template-btn" data-template-id="{{ quiz_template.id }}">
                            <i class="fa-regular fa-floppy-disk"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="course-content-container margin-top-10">
                <!-- Left Column -->
                <div class="course-content-left-column">
                    <div class="details-info-card">
                        <div class="info-card-header collapsable-header">
                            <div class="card-header-left">
                                <i class="fa-regular fa-layer-plus"></i>
                                <span> Template Details </span>
                            </div>
                            <div class="card-header-right">
                                <i class="fa-regular fa-angle-down"></i>
                            </div>
                        </div>
                        <div class="info-card-body">
                            <div class="course-content-input">
                                <label class="edit-user-label" for="title">Template Name<span class="required-asterisk">*</span></label>
                                <input type="text" id="title" name="title" placeholder="Name your template..." value="{{ quiz_template.title }}">
                            </div>
                            <div class="edit-user-input">
                                <label class="edit-user-label" for="category">Main Category</label>
                                <div id="selectedCategories">
                                    <div class="right-column-file-wrapper">
                                        <div id="userDropdown2" class="template-category-dropdown course-content-input">
                                            <input type="text" id="category" name="category" class="categorySearch" placeholder="Search categories..." autocomplete="off" data-child-id="subCategory1">
                                            <i class="fa-regular fa-magnifying-glass search-icon"></i>
                                            <div class="categoryList scrollable-content-inner">
                                                <div class="loadingIndicator" style="display:none;">Loading...</div>
                                            </div>
                                            <div class="dropdown-clear-input">
                                                <i class="fa-solid fa-xmark"></i>
                                            </div>
                                        </div>
                                        <span class="course-content-input-subtext"> Select a main category to unlock subcategories and choose questions from the most specific level. </span>
                                    </div>
                                </div>
                            </div>
                            <div id="subCategoryContainer" class="sub-category-container" style="display: none;">
                                <div id="subCategory1" class="edit-user-input" style="display: none;">
                                    <label class="edit-user-label" for="sub_category1">Sub Category 1</label>
                                    <div id="selectedCategories">
                                        <div class="right-column-file-wrapper">
                                            <div id="userDropdown3" class="template-category-dropdown course-content-input">
                                                <input type="text" id="sub_category1" name="sub_category1" class="categorySearch" placeholder="Search categories..." autocomplete="off" data-child-id="subCategory2">
                                                <i class="fa-regular fa-magnifying-glass search-icon"></i>
                                                <div class="categoryList scrollable-content-inner">
                                                    <div class="loadingIndicator" style="display:none;">Loading...</div>
                                                </div>
                                                <div class="dropdown-clear-input">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="subCategory2" class="edit-user-input" style="display: none;">
                                    <label class="edit-user-label" for="sub_category2">Sub Category 2</label>
                                    <div class="right-column-file-wrapper">
                                        <div id="userDropdown4" class="template-category-dropdown course-content-input">
                                            <input type="text" id="sub_category2" name="sub_category2" class="categorySearch" placeholder="Search categories..." autocomplete="off" data-child-id="subCategory3">
                                            <i class="fa-regular fa-magnifying-glass search-icon"></i>
                                            <div class="categoryList scrollable-content-inner">
                                                <div class="loadingIndicator" style="display:none;">Loading...</div>
                                            </div>
                                            <div class="dropdown-clear-input">
                                                <i class="fa-solid fa-xmark"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="subCategory3" class="edit-user-input" style="display: none;">
                                    <label class="edit-user-label" for="sub_category3">Sub Category 3</label>
                                    <div class="right-column-file-wrapper">
                                        <div id="userDropdown5" class="template-category-dropdown course-content-input">
                                            <input type="text" id="sub_category3" name="sub_category3" class="categorySearch" placeholder="Search categories..." autocomplete="off" data-child-id="subCategory4">
                                            <i class="fa-regular fa-magnifying-glass search-icon"></i>
                                            <div class="categoryList scrollable-content-inner">
                                                <div class="loadingIndicator" style="display:none;">Loading...</div>
                                            </div>
                                            <div class="dropdown-clear-input">
                                                <i class="fa-solid fa-xmark"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>                                
                            </div>
                                                      
                            <div class="edit-user-input">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.4rem;">
                                    <label for="questionCountInput" class="edit-user-label" style="padding-bottom: 0;">Number of Questions</label>
                                    <div class="standard-round-label pastel-gray">
                                        <div id="availableQuestions" class="question-editor-label-text">Total Available Questions: --</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem;">
                                    <div class="edit-user-input">
                                        <input type="number" id="questionCountInput" name="questionCountInput" class="icon-field form-control" placeholder="e.g. 5" min="1" max="999999999">
                                        <span class="input-group-addon">
                                            <i class="fa-regular fa-hashtag"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <span class="course-content-input-subtext"> Select the number of questions of would like to add from this category.</span>
                            </div>
                            
                            <div class="larger-buttons" style="margin-top: 1rem;">
                                <button id="resetCategorySelection" class="action-button-border discard-btn" type="button" style="flex: none;">
                                    <i class="fa-regular fa-rotate"></i>
                                    <span>Reset Category Selection</span>
                                </button>
                                <button class="action-button-primary" onclick="addCategorySelectionToTemplate()" style="flex: none;">
                                    <i class="fa-regular fa-plus"></i>
                                    <span>Add Questions</span>
                                </button> 
                            </div>
                             
                            <!-- <div class="course-content-input">
                                <label class="edit-user-label" for="description">Description</label>
                                <div class="editor-container" id="description"></div>
                                <div class="quill-character-counter">
                                    <div class="quill-current-counter">0</div>
                                    <span>/</span>
                                    <div class="quill-max-counter">2000</div>
                                </div>
                            </div>     -->
                        </div>
                    </div>

                    <div class="details-info-card details-info-card-overflow-hidden">
                        <div class="info-card-header collapsable-header">
                            <div class="card-header-left">
                                <i class="fa-regular fa-circle-question"></i>
                                <span> Template Questions </span>
                            </div>
                            <div class="standard-round-label pastel-gray">
                                <div id="addedQuestions" class="question-editor-label-text">Total Questions Added: --</div>
                            </div>
                            <div class="card-header-right">
                                <i class="fa-regular fa-angle-down"></i>
                            </div>
                        </div>
                        <div style="border: 0;" class="info-card-body padding-0">
                            <table id="templateQuestionTable">
                                <thead>      
                                    <tr>
                                        <th>Category</th>
                                        <th style="width: 160px;">Question #</th>
                                        <th style="width: 80px;">Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                    {% for user_course in user_courses %}
                                        <tr class="table-select-option clickable-row" data-href="{% url 'usercourse_detail_view' uuid=user_course.uuid %}">
                                            <td>
                                                {% if user_course.course.type == 'online' %}
                                                    <div class="course-type-icon online-course tooltip" data-tooltip="Online Course">
                                                        <span class="tooltiptext"></span>
                                                        <i class="fa-solid fa-signal-bars"></i>         
                                                    </div>         
                                                {% else %}
                                                    <div class="course-type-icon inperson-course tooltip" data-tooltip="In Person Course">
                                                        <span class="tooltiptext"></span>
                                                        <i class="fa-solid fa-chalkboard-user"></i>                   
                                                    </div>
                                                {% endif %}
                                                <span class="course-name">{{ user_course.course.title }}</span>                                
                                            </td>
                                            {% if user_course.get_status == 'Not Started' %}
                                                <td><span class="status course-active pastel-gray"> Not Started </span></td>
                                            {% elif user_course.get_status == 'Started' %}
                                                <td><span class="status course-active pastel-yellow"> In Progress </span></td>
                                            {% elif user_course.get_status == 'Completed' %}
                                                <td><span class="status course-active pastel-green"> Completed </span></td>
                                            {% elif user_course.get_status == 'Not Completed' %}
                                                <td><span class="status course-active pastel-gray"> Not Completed </span></td>
                                            {% else %}
                                                <td><span class="status course-active pastel-red"> Expired </span></td>
                                            {% endif %}                                                            
                                            <td>{{ user_course.progress }}%</td>
                                            <td>{{ user_course.enrollment_date }}</td>
                                            <td>{{ user_course.get_scorm_total_time }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script src="{% static 'client_admin\javascript\ajax_search_options.js' %}"></script>
    <link rel="stylesheet" href="{% static 'content\css\content.css' %}">
    <link rel="stylesheet" href="{% static 'client_admin\css\user_details.css' %}">
    <script src="{% static 'client_admin\javascript\popups.js' %}"></script>
    <script src="{% static 'client_admin\javascript\custom_select.js' %}"></script>
    <script src="{% static 'client_admin\javascript\user_details.js' %}"></script>
    <script src="{% static 'content\javascript\quiz_templates.js' %}"></script>
    <script>
        const existingSelections = {{ template_selections|safe }};

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dropdowns
            initTemplateCategoryFlow();
            updateTotalQuestionsAdded();
            initializeSubcategoryDropdown("userDropdown2", null); // Main
            initializeSubcategoryDropdown("userDropdown3", document.getElementById("category"));
            initializeSubcategoryDropdown("userDropdown4", document.getElementById("sub_category1"));
            initializeSubcategoryDropdown("userDropdown5", document.getElementById("sub_category2"));

            // Load prior selections
            if (Array.isArray(existingSelections)) {
                for (const sel of existingSelections) {
                    templateSelections.push(sel);

                    // Also deduct from count cache
                    const categoryId = sel.subCategory3Id || sel.subCategory2Id || sel.subCategory1Id || sel.mainCategoryId;
                    if (categoryId) {
                        fetchQuestionCountForCategory(categoryId);
                    }
                }

                renderTemplateQuestionTable();
                updateTotalQuestionsAdded();
            }
        });
    </script>
{% endblock content %}